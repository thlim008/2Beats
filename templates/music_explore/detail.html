<!-- templates/music_explore/detail.html -->

{% extends 'music_explore/base.html' %}

{% block title %}{{ music.music_title }} - TwoBeats{% endblock %}

{% block extra_css %}
<style>
    /* ìŒì•… ìƒì„¸ í—¤ë” */
    .music-detail-header {
        display: flex;
        gap: 2.5rem;
        align-items: flex-start;
    }
    
    .music-cover {
        flex-shrink: 0;
    }
    
    .music-cover img {
        width: 280px;
        height: 280px;
        border-radius: 16px;
        object-fit: cover;
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    
    .music-cover-placeholder {
        width: 280px;
        height: 280px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 5rem;
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    
    .music-detail-info {
        flex: 1;
        padding-top: 0.5rem;
    }
    
    .music-detail-title {
        font-size: 2rem;
        font-weight: 700;
        color: #222;
        margin-bottom: 0.5rem;
        line-height: 1.3;
    }
    
    .music-detail-artist {
        font-size: 1.3rem;
        color: #666;
        margin-bottom: 1.5rem;
        font-weight: 500;
    }
    
    .music-meta {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        margin-bottom: 1.5rem;
    }
    
    .music-meta-item {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        font-size: 0.95rem;
        color: #555;
    }
    
    .music-meta-label {
        color: #999;
        min-width: 70px;
    }
    
    .music-meta-value {
        font-weight: 500;
    }
    
    /* íƒœê·¸ */
    .music-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1.8rem;
    }
    
    .music-tag {
        display: inline-block;
        background-color: #f0f7f0;
        color: #1db954;
        padding: 0.4rem 0.9rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .music-tag:hover {
        background-color: #e0f2e0;
    }
    
    /* ì•¡ì…˜ ë²„íŠ¼ */
    .music-actions {
        display: flex;
        gap: 0.8rem;
        flex-wrap: wrap;
    }
    
    .action-btn {
        padding: 0.7rem 1.4rem;
        border-radius: 25px;
        font-size: 0.95rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
    }
    
    .action-btn-play {
        background: linear-gradient(135deg, #1db954, #1ed760);
        color: white;
        box-shadow: 0 4px 15px rgba(29, 185, 84, 0.3);
    }
    
    .action-btn-play:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(29, 185, 84, 0.4);
    }
    
    .action-btn-like {
        background-color: #fff;
        color: #555;
        border: 2px solid #e8e8e8;
    }
    
    .action-btn-like:hover {
        border-color: #ff6b6b;
        color: #ff6b6b;
    }
    
    .action-btn-like.liked {
        background-color: #fff0f0;
        border-color: #ff6b6b;
        color: #ff6b6b;
    }
    
    .action-btn-playlist {
        background-color: #f5f5f5;
        color: #555;
        border: 2px solid transparent;
    }
    
    .action-btn-playlist:hover {
        background-color: #eee;
    }
    
    /* ëŒ“ê¸€ ì„¹ì…˜ */
    .comment-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .comment-count {
        background-color: #f0f0f0;
        color: #666;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    /* ëŒ“ê¸€ ì‘ì„± */
    .comment-form {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .comment-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }
    
    .comment-avatar-placeholder {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 1rem;
        flex-shrink: 0;
    }
    
    .comment-form-content {
        flex: 1;
    }
    
    .comment-input {
        width: 100%;
        padding: 0.9rem 1rem;
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 0.95rem;
        resize: none;
        transition: all 0.2s;
        font-family: inherit;
        background-color: #0c0a18;
        color: var(--text);
    }

    .comment-input:focus {
        outline: none;
        border-color: var(--accent);
        background-color: #0e0c1c;
        box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
    }
    .comment-input::placeholder { color: var(--muted); }
    
    .comment-submit-row {
        display: flex;
        justify-content: flex-end;
        margin-top: 0.8rem;
    }
    
    /* ëŒ“ê¸€ ëª©ë¡ */
    .comment-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .comment-item {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        border-radius: 12px;
        background-color: #fafafa;
        transition: background-color 0.2s;
    }
    
    .comment-item:hover {
        background-color: #f5f5f5;
    }
    
    .comment-body {
        flex: 1;
    }
    
    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .comment-author {
        font-weight: 600;
        color: #333;
        font-size: 0.95rem;
    }
    
    .comment-date {
        color: #999;
        font-size: 0.8rem;
    }
    
    .comment-text {
        color: #555;
        font-size: 0.95rem;
        line-height: 1.5;
    }
    
    .comment-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .comment-action-btn {
        background: none;
        border: none;
        font-size: 0.85rem;
        cursor: pointer;
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        transition: all 0.2s;
    }
    
    .comment-action-btn.edit {
        color: #1db954;
    }
    
    .comment-action-btn.edit:hover {
        background-color: #e8f5e9;
    }
    
    .comment-action-btn.delete {
        color: #ff6b6b;
    }
    
    .comment-action-btn.delete:hover {
        background-color: #ffebee;
    }
    
    /* ëŒ“ê¸€ ìˆ˜ì • í¼ */
    .comment-edit-form {
        margin-top: 0.8rem;
    }
    
    .comment-edit-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .comment-edit-btn {
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .comment-edit-btn.save {
        background: linear-gradient(135deg, #1db954, #1ed760);
        color: white;
        border: none;
    }
    
    .comment-edit-btn.cancel {
        background-color: #f5f5f5;
        color: #666;
        border: 1px solid #e0e0e0;
    }
    
    /* ë¹ˆ ëŒ“ê¸€ */
    .empty-comments {
        text-align: center;
        padding: 2.5rem;
        color: #999;
    }
    
    .empty-comments-icon {
        font-size: 2.5rem;
        margin-bottom: 0.8rem;
    }
    
    /* ë¡œê·¸ì¸ í•„ìš” */
    .login-required {
        text-align: center;
        padding: 1.2rem;
        background-color: #f9f9f9;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        color: #666;
    }
    
    .login-required a {
        color: #1db954;
        font-weight: 600;
        text-decoration: none;
    }
    
    .login-required a:hover {
        text-decoration: underline;
    }
    
    /* ë©”ì‹œì§€ */
    .message {
        padding: 1rem 1.2rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        font-size: 0.95rem;
    }
    
    .message-success {
        background-color: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
    }
    
    .message-error {
        background-color: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
    }
</style>
{% endblock %}

{% block content %}

<!-- ë©”ì‹œì§€ í‘œì‹œ -->
{% if messages %}
    {% for message in messages %}
        <div class="message {% if message.tags == 'success' %}message-success{% else %}message-error{% endif %}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<!-- ìŒì•… ì •ë³´ -->
<div class="card">
    <div class="music-detail-header">
        <!-- ì»¤ë²„ ì´ë¯¸ì§€ -->
        <div class="music-cover">
            {% if music.music_thumbnail %}
                <img src="{{ music.music_thumbnail.url }}" alt="{{ music.music_title }}">
            {% else %}
                <div class="music-cover-placeholder">ğŸµ</div>
            {% endif %}
        </div>
        
        <!-- ì •ë³´ -->
        <div class="music-detail-info">
            <h1 class="music-detail-title">{{ music.music_title }}</h1>
            <p class="music-detail-artist">{{ music.music_singer }}</p>
            
            <div class="music-meta">
                <div class="music-meta-item">
                    <span class="music-meta-label">ì¥ë¥´</span>
                    <span class="music-meta-value">{{ music.get_music_type_display }}</span>
                </div>
                <div class="music-meta-item">
                    <span class="music-meta-label">ì—…ë¡œë”</span>
                    <span class="music-meta-value">{{ music.uploader.username }}</span>
                </div>
                <div class="music-meta-item">
                    <span class="music-meta-label">ì¬ìƒìˆ˜</span>
                    <span class="music-meta-value">{{ music.music_count }}íšŒ</span>
                </div>
                <div class="music-meta-item">
                    <span class="music-meta-label">ì¢‹ì•„ìš”</span>
                    <span class="music-meta-value" id="like-count">{{ music.music_like_count }}</span>
                </div>
            </div>
            
            <!-- íƒœê·¸ -->
            {% if music.tags.all %}
                <div class="music-tags">
                    {% for tag in music.tags.all %}
                        <span class="music-tag">#{{ tag.name }}</span>
                    {% endfor %}
                </div>
            {% endif %}
            
            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
            <div class="music-actions">
                <!-- ì¬ìƒ ë²„íŠ¼ -->
                {% if music.music_root %}
                <button 
                    class="action-btn action-btn-play"
                    data-id="{{ music.id }}"
                    data-title="{{ music.music_title }}"
                    data-singer="{{ music.music_singer }}"
                    data-url="{{ music.music_root.url }}"
                    data-thumb="{% if music.music_thumbnail %}{{ music.music_thumbnail.url }}{% endif %}"
                    onclick="playMusicFromData(this)"
                >
                    â–¶ï¸ ì¬ìƒ
                </button>
                {% endif %}
                
                <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
                {% if user.is_authenticated %}
                    <button 
                        id="like-btn"
                        onclick="toggleLike({{ music.id }})"
                        class="action-btn action-btn-like {% if is_liked %}liked{% endif %}"
                        data-liked="{% if is_liked %}true{% else %}false{% endif %}"
                    >
                        <span id="like-text">{% if is_liked %}â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ{% else %}ğŸ¤ ì¢‹ì•„ìš”{% endif %}</span>
                    </button>
                {% else %}
                    <a href="/admin/" class="action-btn action-btn-like">ğŸ¤ ì¢‹ì•„ìš” (ë¡œê·¸ì¸ í•„ìš”)</a>
                {% endif %}
                
                <!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë²„íŠ¼ -->
                <button class="action-btn action-btn-playlist" onclick="addToPlaylistFromDetail()">
                    ğŸ“‹ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ëŒ“ê¸€ -->
<div class="card">
    <h2 class="comment-section-title">
        ğŸ’¬ ëŒ“ê¸€ 
        <span class="comment-count">{{ comments.count }}</span>
    </h2>
    
    <!-- ëŒ“ê¸€ ì‘ì„± -->
    {% if user.is_authenticated %}
        <form method="POST" action="{% url 'music_explore:comment' music.id %}" class="comment-form">
            {% csrf_token %}
            {% if user.profile_image %}
                <img src="{{ user.profile_image.url }}" class="comment-avatar" alt="{{ user.username }}">
            {% else %}
                <div class="comment-avatar-placeholder">
                    {{ user.username|slice:":1"|upper }}
                </div>
            {% endif %}
            
            <div class="comment-form-content">
                <textarea 
                    name="content" 
                    rows="2" 
                    class="comment-input"
                    placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                    required
                ></textarea>
                <div class="comment-submit-row">
                    <button type="submit" class="btn btn-primary">ëŒ“ê¸€ ì‘ì„±</button>
                </div>
            </div>
        </form>
    {% else %}
        <div class="login-required">
            ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/admin/">ë¡œê·¸ì¸</a>í•˜ì„¸ìš”.
        </div>
    {% endif %}
    
    <!-- ëŒ“ê¸€ ëª©ë¡ -->
    {% if comments %}
        <div class="comment-list">
            {% for comment in comments %}
                <div class="comment-item">
                    <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
                    {% if comment.user.profile_image %}
                        <img src="{{ comment.user.profile_image.url }}" class="comment-avatar" alt="{{ comment.user.username }}">
                    {% else %}
                        <div class="comment-avatar-placeholder">
                            {{ comment.user.username|slice:":1"|upper }}
                        </div>
                    {% endif %}
                    
                    <div class="comment-body">
                        <div class="comment-header">
                            <span class="comment-author">{{ comment.user.username }}</span>
                            <span class="comment-date" data-time="{{ comment.created_at|date:'c' }}">{{ comment.created_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        
                        <!-- ëŒ“ê¸€ ë‚´ìš© -->
                        <div id="comment-content-{{ comment.id }}">
                            <p class="comment-text">{{ comment.content }}</p>
                            
                            {% if user == comment.user %}
                            <div class="comment-actions">
                                <button class="comment-action-btn edit" onclick="showEditForm({{ comment.id }})">
                                    âœï¸ ìˆ˜ì •
                                </button>
                                <form method="POST" action="{% url 'music_explore:comment_delete' comment.id %}" style="display: inline;" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                    {% csrf_token %}
                                    <button type="submit" class="comment-action-btn delete">
                                        ğŸ—‘ï¸ ì‚­ì œ
                                    </button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- ëŒ“ê¸€ ìˆ˜ì • í¼ -->
                        <div id="comment-edit-{{ comment.id }}" style="display: none;">
                            <form method="POST" action="{% url 'music_explore:comment_edit' comment.id %}" class="comment-edit-form">
                                {% csrf_token %}
                                <textarea 
                                    name="content" 
                                    rows="2" 
                                    class="comment-input"
                                    required
                                >{{ comment.content }}</textarea>
                                <div class="comment-edit-buttons">
                                    <button type="submit" class="comment-edit-btn save">ì €ì¥</button>
                                    <button type="button" class="comment-edit-btn cancel" onclick="hideEditForm({{ comment.id }})">ì·¨ì†Œ</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-comments">
            <div class="empty-comments-icon">ğŸ’¬</div>
            <p>ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
        </div>
    {% endif %}
</div>
{% endblock %}


{% block extra_js %}
<script>
// CSRF í† í°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ì¢‹ì•„ìš” í† ê¸€
function toggleLike(musicId) {
    const likeBtn = document.getElementById('like-btn');
    const likeText = document.getElementById('like-text');
    const likeCount = document.getElementById('like-count');
    
    fetch(`/music/like/${musicId}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken'),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.is_liked) {
            likeBtn.classList.add('liked');
            likeText.textContent = 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ';
            showToast('ì¢‹ì•„ìš” ì¶”ê°€!', 'success');
        } else {
            likeBtn.classList.remove('liked');
            likeText.textContent = 'ğŸ¤ ì¢‹ì•„ìš”';
            showToast('ì¢‹ì•„ìš” ì·¨ì†Œ', 'info');
        }
        likeCount.textContent = data.like_count;
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    });
}

// í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
function addToPlaylistFromDetail() {
    {% if not user.is_authenticated %}
    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
    return;
    {% else %}
    const musicId = {{ music.id }};
    const csrftoken = getCookie('csrftoken');

    fetch('/account/api/playlist/add-music/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: `music_id=${encodeURIComponent(musicId)}`,
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            if (data.removed) {
                showToast('í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°í–ˆìŠµë‹ˆë‹¤.', 'info');
            } else {
                showToast('ë‚˜ì˜ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í–ˆì–´ìš”.', 'success');
            }
        } else {
            showToast(data.error || 'ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    })
    .catch(() => {
        showToast('ì¶”ê°€/ì œê±° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    });
    {% endif %}
}

// ëŒ“ê¸€ ìˆ˜ì • í¼ í‘œì‹œ
function showEditForm(commentId) {
    document.getElementById('comment-content-' + commentId).style.display = 'none';
    document.getElementById('comment-edit-' + commentId).style.display = 'block';
}

// ëŒ“ê¸€ ìˆ˜ì • í¼ ìˆ¨ê¸°ê¸°
function hideEditForm(commentId) {
    document.getElementById('comment-content-' + commentId).style.display = 'block';
    document.getElementById('comment-edit-' + commentId).style.display = 'none';
}

// ì¢‹ì•„ìš” ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (5ì´ˆë§ˆë‹¤)
setInterval(() => {
    const musicId = {{ music.id }};
    fetch(`/music/like-status/${musicId}/`)
        .then(response => response.json())
        .then(data => {
            // ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸
            document.getElementById('like-count').textContent = data.like_count;
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ë¡œê·¸ì¸í•œ ê²½ìš°ë§Œ)
            {% if user.is_authenticated %}
            const likeBtn = document.getElementById('like-btn');
            const likeText = document.getElementById('like-text');
            
            if (likeBtn) {
                if (data.is_liked) {
                    likeBtn.classList.add('liked');
                    likeText.textContent = 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ';
                } else {
                    likeBtn.classList.remove('liked');
                    likeText.textContent = 'ğŸ¤ ì¢‹ì•„ìš”';
                }
            }
            {% endif %}
        });
}, 5000);
// ì‹œê°„ ë³€í™˜ í•¨ìˆ˜
function timeAgo(dateString) {
    const now = new Date();
    const date = new Date(dateString);
    const diff = Math.floor((now - date) / 1000);
    
    if (diff < 60) return 'ë°©ê¸ˆ ì „';
    if (diff < 3600) return Math.floor(diff / 60) + 'ë¶„ ì „';
    if (diff < 86400) return Math.floor(diff / 3600) + 'ì‹œê°„ ì „';
    if (diff < 604800) return Math.floor(diff / 86400) + 'ì¼ ì „';
    
    // ì¼ì£¼ì¼ ë„˜ìœ¼ë©´ ì›ë˜ ë‚ ì§œ í‘œì‹œ
    return dateString.split('T')[0];
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œê°„ ë³€í™˜
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.comment-date').forEach(el => {
        const time = el.dataset.time;
        if (time) {
            el.textContent = timeAgo(time);
        }
    });
});

// 1ë¶„ë§ˆë‹¤ ì—…ë°ì´íŠ¸
setInterval(() => {
    document.querySelectorAll('.comment-date').forEach(el => {
        const time = el.dataset.time;
        if (time) {
            el.textContent = timeAgo(time);
        }
    });
}, 60000);
</script>
{% endblock %}
