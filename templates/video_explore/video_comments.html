<!-- ëŒ“ê¸€ ì„¹ì…˜ ìŠ¤íƒ€ì¼ -->
<style>
    /* ëŒ“ê¸€ ì„¹ì…˜ */
    .comments-section {
        margin-top: 40px;
    }

    .comments-section h3 {
        margin-bottom: 20px;
        font-size: 20px;
    }

    .comment-form {
        margin-bottom: 30px;
    }

    .comment-form textarea {
        width: 100%;
        padding: 15px;
        border: 1px solid var(--border);
        border-radius: 10px;
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
        background: #0c0a18;
        color: var(--text);
    }

    .comment-form textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(124,58,237,0.2);
    }

    .comment-form button {
        margin-top: 10px;
        padding: 12px 30px;
        background-color: #00CD3C;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
    }

    .comment-form button:hover {
        background-color: #00b835;
    }

    .comment-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .comment-item {
        padding: 15px;
        background-color: #f8f8f8;
        border-radius: 8px;
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .comment-author-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .comment-author-image {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #e0e0e0;
    }

    .comment-author {
        font-weight: bold;
        color: #333;
    }

    .comment-date {
        color: #999;
        font-size: 13px;
    }

    .comment-content {
        color: #333;
        line-height: 1.5;
    }

    .comment-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .comment-btn {
        padding: 5px 12px;
        font-size: 12px;
        border: 1px solid #e0e0e0;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .comment-btn:hover {
        background-color: #f5f5f5;
    }

    .comment-btn.edit-btn:hover {
        border-color: #00CD3C;
        color: #00CD3C;
    }

    .comment-btn.delete-btn:hover {
        border-color: #ff0000;
        color: #ff0000;
    }

    .comment-edit-form {
        margin-top: 10px;
    }

    .comment-edit-form textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
        resize: vertical;
        min-height: 60px;
        font-family: inherit;
        background: #0c0a18;
        color: var(--text);
    }

    .comment-edit-form .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 8px;
    }

    .comment-edit-form button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }

    .comment-edit-form .save-btn {
        background-color: #00CD3C;
        color: white;
    }

    .comment-edit-form .save-btn:hover {
        background-color: #00b835;
    }

    .comment-edit-form .cancel-btn {
        background-color: #e0e0e0;
        color: #333;
    }

    .comment-edit-form .cancel-btn:hover {
        background-color: #d0d0d0;
    }

    /* ë¡œê·¸ì¸ í•„ìš” ë©”ì‹œì§€ */
    .login-required {
        padding: 15px;
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
    }
</style>
<style>
    /* 2beats dark theme override */
    :root {
        --bg: #090712;
        --card: #120f1f;
        --accent: #c084fc;
        --accent-2: #7c3aed;
        --text: #f7f8ff;
        --muted: #c7c9d9;
        --border: #1f1b2d;
    }
    body {
        background: radial-gradient(circle at 15% 20%, rgba(124,58,237,0.16), transparent 40%),
                    radial-gradient(circle at 80% 0%, rgba(192,132,252,0.12), transparent 45%),
                    linear-gradient(160deg, #090712, #0e0a19 60%, #0a0814);
        color: var(--text);
    }
    .comments-container {
        background: linear-gradient(140deg, rgba(124,58,237,0.12), rgba(192,132,252,0.12), var(--card));
        border: 1px solid var(--border);
        box-shadow: 0 18px 60px rgba(0,0,0,0.45);
    }
    .comment-item {
        border-bottom: 1px solid var(--border);
    }
    .btn-primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #0b1220;
        border: none;
        box-shadow: 0 6px 14px rgba(124,58,237,0.4);
    }
    .btn-secondary {
        background: transparent;
        color: var(--text);
        border: 1px solid var(--border);
    }
    input, textarea {
        background: #0c0a18;
        color: var(--text);
        border: 1px solid var(--border);
    }
    input:focus, textarea:focus {
        border-color: var(--accent);
        outline: none;
        box-shadow: 0 0 0 3px rgba(124,58,237,0.2);
    }
</style>

<!-- ëŒ“ê¸€ ì„¹ì…˜ HTML -->
<div class="comments-section">
    <h3>ğŸ’¬ ëŒ“ê¸€ {{ comments.count }}</h3>

    {% if user.is_authenticated %}
    <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
    <div class="comment-form">
        <textarea id="comment-content" placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
        <button onclick="addComment({{ video.pk }})">ë“±ë¡</button>
    </div>
    {% else %}
    <div class="login-required">
        ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
    </div>
    {% endif %}

    <!-- ëŒ“ê¸€ ëª©ë¡ -->
    <div class="comment-list" id="comment-list">
        {% for comment in comments %}
        <div class="comment-item" data-comment-id="{{ comment.pk }}">
            <div class="comment-header">
                <div class="comment-author-info">
                    {% if comment.user.profile_image %}
                    <img src="{{ comment.user.profile_image.url }}" alt="{{ comment.user.username }}" class="comment-author-image">
                    {% else %}
                    <div class="comment-author-image" style="display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ‘¤</div>
                    {% endif %}
                    <span class="comment-author">
                        {{ comment.user.username }}
                    </span>
                </div>
                <span class="comment-date">{{ comment.created_at|date:"Y.m.d H:i" }}</span>
            </div>
            <div class="comment-content">{{ comment.content }}</div>

            {% if user == comment.user %}
            <div class="comment-actions">
                <button class="comment-btn edit-btn" onclick="editComment({{ comment.pk }})">ìˆ˜ì •</button>
                <button class="comment-btn delete-btn" onclick="deleteComment({{ comment.pk }})">ì‚­ì œ</button>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <p style="text-align: center; color: #999; padding: 40px 0;">
            ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!
        </p>
        {% endfor %}
    </div>

    <!-- ëŒ“ê¸€ í˜ì´ì§€ë„¤ì´ì…˜ -->
    {% if comments.has_other_pages %}
    <div class="pagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 30px; padding: 20px 0;">
        {% if comments.has_previous %}
        <a href="?page=1" style="padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 4px; text-decoration: none; color: #333;">ì²˜ìŒ</a>
        <a href="?page={{ comments.previous_page_number }}" style="padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 4px; text-decoration: none; color: #333;">ì´ì „</a>
        {% endif %}

        <span style="padding: 8px 12px; border: 2px solid #00CD3C; border-radius: 4px; background-color: #00CD3C; color: white; font-weight: bold;">
            {{ comments.number }} / {{ comments.paginator.num_pages }}
        </span>

        {% if comments.has_next %}
        <a href="?page={{ comments.next_page_number }}" style="padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 4px; text-decoration: none; color: #333;">ë‹¤ìŒ</a>
        <a href="?page={{ comments.paginator.num_pages }}" style="padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 4px; text-decoration: none; color: #333;">ë§ˆì§€ë§‰</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- ëŒ“ê¸€ ì„¹ì…˜ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    // ëŒ“ê¸€ ì‘ì„±
    function addComment(videoId) {
        const content = document.getElementById('comment-content').value.trim();

        if (!content) {
            alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const formData = new FormData();
        formData.append('content', content);

        fetch(`/video/${videoId}/comment/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ëŒ“ê¸€ ì…ë ¥ì°½ ë¹„ìš°ê¸°
                document.getElementById('comment-content').value = '';

                // ëŒ“ê¸€ ëª©ë¡ì— ìƒˆ ëŒ“ê¸€ ì¶”ê°€
                const commentList = document.getElementById('comment-list');

                // "ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤" ë©”ì‹œì§€ ì œê±°
                const emptyMessage = commentList.querySelector('p');
                if (emptyMessage) {
                    emptyMessage.remove();
                }

                const newComment = document.createElement('div');
                newComment.className = 'comment-item';
                newComment.setAttribute('data-comment-id', data.comment.id);

                // í”„ë¡œí•„ ì´ë¯¸ì§€ URL (í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì •ë³´ëŠ” ì„œë²„ì—ì„œ ë°›ì•„ì™€ì•¼ í•¨)
                const profileImageHTML = data.comment.user_image
                    ? `<img src="${data.comment.user_image}" alt="${data.comment.username}" class="comment-author-image">`
                    : `<div class="comment-author-image" style="display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ‘¤</div>`;

                newComment.innerHTML = `
                    <div class="comment-header">
                        <div class="comment-author-info">
                            ${profileImageHTML}
                            <span class="comment-author">
                                ${data.comment.username}
                            </span>
                        </div>
                        <span class="comment-date">${data.comment.created_at}</span>
                    </div>
                    <div class="comment-content" id="comment-content-${data.comment.id}"></div>
                    <div class="comment-actions">
                        <button class="comment-btn edit-btn" onclick="editComment(${data.comment.id})">ìˆ˜ì •</button>
                        <button class="comment-btn delete-btn" onclick="deleteComment(${data.comment.id})">ì‚­ì œ</button>
                    </div>
                `;

                // ìµœìƒë‹¨ì— ì¶”ê°€ (ë¨¼ì € DOMì— ì¶”ê°€í•´ì•¼ getElementByIdê°€ ì‘ë™í•¨)
                commentList.insertBefore(newComment, commentList.firstChild);

                // XSS ë°©ì§€: textContent ì‚¬ìš© (HTML íƒœê·¸ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ)
                document.getElementById(`comment-content-${data.comment.id}`).textContent = data.comment.content;

                alert('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                alert(data.error || 'ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // ëŒ“ê¸€ ìˆ˜ì •
    function editComment(commentId) {
        const commentItem = document.querySelector(`[data-comment-id="${commentId}"]`);
        const contentDiv = commentItem.querySelector('.comment-content');
        const actionsDiv = commentItem.querySelector('.comment-actions');
        const originalContent = contentDiv.textContent;

        // ìˆ˜ì • í¼ ìƒì„±
        const editForm = document.createElement('div');
        editForm.className = 'comment-edit-form';
        editForm.innerHTML = `
            <textarea id="edit-textarea-${commentId}">${originalContent}</textarea>
            <div class="btn-group">
                <button class="save-btn" onclick="saveComment(${commentId})">ì €ì¥</button>
                <button class="cancel-btn" onclick="cancelEdit(${commentId}, '${originalContent.replace(/'/g, "\\'")}')">ì·¨ì†Œ</button>
            </div>
        `;

        // ê¸°ì¡´ ë‚´ìš©ê³¼ ì•¡ì…˜ ë²„íŠ¼ ìˆ¨ê¸°ê³  ìˆ˜ì • í¼ í‘œì‹œ
        contentDiv.style.display = 'none';
        actionsDiv.style.display = 'none';
        contentDiv.after(editForm);
    }

    // ëŒ“ê¸€ ìˆ˜ì • ì €ì¥
    function saveComment(commentId) {
        const newContent = document.getElementById(`edit-textarea-${commentId}`).value.trim();

        if (!newContent) {
            alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const formData = new FormData();
        formData.append('content', newContent);

        fetch(`/video/comment/${commentId}/edit/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ëŒ“ê¸€ ë‚´ìš© ì—…ë°ì´íŠ¸
                const commentItem = document.querySelector(`[data-comment-id="${commentId}"]`);
                const contentDiv = commentItem.querySelector('.comment-content');
                const actionsDiv = commentItem.querySelector('.comment-actions');
                const editForm = commentItem.querySelector('.comment-edit-form');

                contentDiv.textContent = data.comment.content;
                contentDiv.style.display = 'block';
                actionsDiv.style.display = 'flex';
                editForm.remove();

                alert('ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                alert(data.error || 'ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // ëŒ“ê¸€ ìˆ˜ì • ì·¨ì†Œ
    function cancelEdit(commentId, originalContent) {
        const commentItem = document.querySelector(`[data-comment-id="${commentId}"]`);
        const contentDiv = commentItem.querySelector('.comment-content');
        const actionsDiv = commentItem.querySelector('.comment-actions');
        const editForm = commentItem.querySelector('.comment-edit-form');

        contentDiv.style.display = 'block';
        actionsDiv.style.display = 'flex';
        editForm.remove();
    }

    // ëŒ“ê¸€ ì‚­ì œ
    function deleteComment(commentId) {
        if (!confirm('ì •ë§ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        fetch(`/video/comment/${commentId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ëŒ“ê¸€ í•­ëª© ì œê±°
                const commentItem = document.querySelector(`[data-comment-id="${commentId}"]`);
                commentItem.remove();

                // ëŒ“ê¸€ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìœ¼ë©´ ë¹ˆ ë©”ì‹œì§€ í‘œì‹œ
                const commentList = document.getElementById('comment-list');
                if (commentList.children.length === 0) {
                    commentList.innerHTML = `
                        <p style="text-align: center; color: #999; padding: 40px 0;">
                            ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!
                        </p>
                    `;
                }

                alert('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                alert(data.error || 'ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
</script>
