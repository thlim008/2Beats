{% extends "base.html" %}

{% block content %}
<div class="tb-upload-page">
  <div class="tb-upload-header">
    <h1 class="tb-page-title">Track info</h1>
    <p class="tb-page-subtitle">íŠ¸ë™ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ì•„íŠ¸ì›Œí¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>
  </div>

  <form method="post" enctype="multipart/form-data" class="tb-upload-form" id="music-form">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="tb-form-errors">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <div class="tb-upload-layout">
      <section class="tb-upload-left">
        <div class="tb-artwork-card"
          tabindex="-1"
          onclick="document.getElementById('id_music_thumbnail').click()">
          <img
            id="tb-artwork-preview"
            class="tb-artwork-preview"
            alt="Artwork"
            src="{% if music and music.music_thumbnail %}{{ music.music_thumbnail.url }}{% endif %}"
            {% if not music or not music.music_thumbnail %}style="display:none;"{% endif %}
          >
          <div id="tb-artwork-placeholder"
              class="tb-artwork-placeholder"
              {% if music and music.music_thumbnail %}style="display:none;"{% endif %}>
            <div class="tb-artwork-icon">
              <svg width="48" height="48" viewBox="0 0 24 24"
                  fill="none" stroke="currentColor" stroke-width="1.5"
                  stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <path d="M21 15l-5-5L5 21"></path>
              </svg>
            </div>
            <span class="tb-artwork-text">Add new artwork</span>
            <span class="tb-artwork-hint">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</span>
          </div>
        </div>
        {{ form.music_thumbnail }}
        {% if form.music_thumbnail.errors %}
          <div class="tb-field-error">
            {{ form.music_thumbnail.errors }}
          </div>
        {% endif %}
      </section>

      <section class="tb-upload-right">
        <div class="tb-field-row">
          <label class="tb-label" for="id_music_title">
            <span class="tb-label-text">Track title</span>
            <span class="tb-required">*</span>
          </label>
          <div class="tb-field-main">
            {{ form.music_title }}
            {% if form.music_title.errors %}
              <div class="tb-field-error">
                {{ form.music_title.errors }}
              </div>
            {% endif %}
          </div>
        </div>

        <div class="tb-field-row">
          <label class="tb-label" for="id_music_singer">
            <span class="tb-label-text">Main artist</span>
            <span class="tb-required">*</span>
          </label>
          <div class="tb-field-main">
            {{ form.music_singer }}
            {% if form.music_singer.errors %}
              <div class="tb-field-error">
                {{ form.music_singer.errors }}
              </div>
            {% endif %}
            <p class="tb-help-text">
              ì—¬ëŸ¬ ëª…ì¼ ê²½ìš° ì‰¼í‘œë¡œ êµ¬ë¶„í•´ë„ ì¢‹ì•„ìš”
            </p>
          </div>
        </div>

        <div class="tb-field-row">
          <label class="tb-label" for="id_music_type">
            <span class="tb-label-text">Genre</span>
            <span class="tb-required">*</span>
          </label>
          <div class="tb-field-main">
            {{ form.music_type }}
            {% if form.music_type.errors %}
              <div class="tb-field-error">
                {{ form.music_type.errors }}
              </div>
            {% endif %}
          </div>
        </div>

        <div class="tb-field-row">
          <label class="tb-label">
            <span class="tb-label-text">Tags</span>
          </label>
          <div class="tb-field-main">
            <div class="tb-tags-grid">
              {% for tag in form.tags.field.queryset %}
                <label class="tb-tag-checkbox" for="tag_{{ tag.id }}">
                  <input 
                    type="checkbox" 
                    name="tags" 
                    value="{{ tag.id }}"
                    id="tag_{{ tag.id }}"
                    {% if tag in form.instance.tags.all %}checked{% endif %}
                  >
                  <span class="tb-tag-label">#{{ tag.name }}</span>
                </label>
              {% empty %}
                <div class="tb-alert-warning">
                  âš ï¸ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. <code>python manage.py init_tags</code> ì‹¤í–‰í•˜ì„¸ìš”.
                </div>
              {% endfor %}
            </div>
            {% if form.tags.errors %}
              <div class="tb-field-error">
                {{ form.tags.errors }}
              </div>
            {% endif %}
            <p class="tb-help-text">
              ë¶„ìœ„ê¸°, í…œí¬, ì‚¬ìš©ì²˜ ë“±ì— ë§ëŠ” íƒœê·¸ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš” (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)
            </p>
          </div>
        </div>
      </section>
    </div>

    <div class="tb-upload-footer">
      <a href="{% url 'twobeats_upload:music_list' %}" class="tb-btn-cancel" id="cancel-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        <span>ì·¨ì†Œ</span>
      </a>
      <button type="submit" class="tb-btn-submit" id="submit-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
        <span id="submit-text">ì €ì¥ í›„ ì™„ë£Œ</span>
      </button>
    </div>
  </form>
</div>

<script>
(function () {
  let isSubmitting = false;
  const musicForm = document.getElementById('music-form');
  const submitBtn = document.getElementById('submit-btn');
  const submitText = document.getElementById('submit-text');

  // ğŸ”¥ í¼ ì œì¶œ ì´ë²¤íŠ¸
  if (musicForm && submitBtn) {
    musicForm.addEventListener('submit', function(e) {
      if (isSubmitting) {
        e.preventDefault();
        return false;
      }
      isSubmitting = true;
      submitBtn.disabled = true;
      submitText.textContent = 'ì €ì¥ ì¤‘...';
    });
  }

  // ğŸ”¥ ë’¤ë¡œê°€ê¸° ê°ì§€ â†’ ì„¸ì…˜ ì •ë¦¬
  window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
      // bfcache ë³µì› (ë’¤ë¡œê°€ê¸°)
      isSubmitting = false;
      if (submitBtn) {
        submitBtn.disabled = false;
        submitText.textContent = 'ì €ì¥ í›„ ì™„ë£Œ';
      }
      
      // ğŸ”¥ ì„¸ì…˜ ì •ë¦¬ ìš”ì²­
      fetch("{% url 'twobeats_upload:cleanup_temp_music' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      }).catch(err => console.error('Cleanup failed:', err));
    }
  });

  // ğŸ”¥ ì·¨ì†Œ ë²„íŠ¼
  const cancelBtn = document.getElementById('cancel-btn');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function(e) {
      if (isSubmitting) {
        e.preventDefault();
        alert('ì €ì¥ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
        return;
      }
      
      // ğŸ”¥ ì·¨ì†Œ ì‹œ ì„¸ì…˜ ì •ë¦¬
      e.preventDefault();
      fetch("{% url 'twobeats_upload:cleanup_temp_music' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      }).then(() => {
        window.location.href = "{% url 'twobeats_upload:music_list' %}";
      }).catch(err => {
        console.error('Cleanup failed:', err);
        window.location.href = "{% url 'twobeats_upload:music_list' %}";
      });
    });
  }

  // ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°
  const input = document.getElementById('id_music_thumbnail');
  const img = document.getElementById('tb-artwork-preview');
  const placeholder = document.getElementById('tb-artwork-placeholder');

  if (input && img) {
    input.addEventListener('change', function () {
      if (this.files && this.files[0]) {
        const file = this.files[0];
        if (file.size > 10 * 1024 * 1024) {
          alert('ì´ë¯¸ì§€ íŒŒì¼ì€ 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          this.value = '';
          return;
        }
        const url = URL.createObjectURL(file);
        img.src = url;
        img.style.display = 'block';
        if (placeholder) {
          placeholder.style.display = 'none';
        }
      }
    });
  }
})();
</script>

<style>
/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë™ì¼... */
.tb-upload-page { max-width: 1400px; margin: 0 auto; padding: 2rem; }
.tb-upload-header { margin-bottom: 2.5rem; text-align: center; }
.tb-page-title { font-size: 2.5rem; font-weight: 700; color: #ffffff; margin: 0 0 0.5rem 0; background: linear-gradient(135deg, #c084fc, #7c3aed); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.tb-page-subtitle { color: #94a3b8; font-size: 1rem; margin: 0; }
.tb-upload-layout { display: grid; grid-template-columns: 380px 1fr; gap: 3rem; margin-bottom: 2rem; }
@media (max-width: 1024px) { .tb-upload-layout { grid-template-columns: 1fr; gap: 2rem; } }
.tb-upload-left { position: sticky; top: 2rem; height: fit-content; }
.tb-artwork-card { position: relative; width: 100%; aspect-ratio: 1; background: rgba(255, 255, 255, 0.03); border: 2px dashed rgba(255, 255, 255, 0.15); border-radius: 1rem; overflow: hidden; cursor: pointer; transition: all 0.3s; }
.tb-artwork-card:hover { border-color: rgba(192, 132, 252, 0.5); background: rgba(192, 132, 252, 0.05); transform: translateY(-2px); }
.tb-artwork-preview { width: 100%; height: 100%; object-fit: cover; }
.tb-artwork-placeholder { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem; }
.tb-artwork-icon { color: #64748b; transition: all 0.3s; }
.tb-artwork-card:hover .tb-artwork-icon { color: #c084fc; transform: scale(1.1); }
.tb-artwork-text { font-size: 1.125rem; font-weight: 600; color: #cbd5e1; }
.tb-artwork-hint { font-size: 0.875rem; color: #64748b; }
#id_music_thumbnail, #id_video_thumbnail { display: none; }
.tb-upload-right { display: flex; flex-direction: column; gap: 2rem; }
.tb-field-row { display: flex; flex-direction: column; gap: 0.75rem; }
.tb-label { display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; font-weight: 600; color: #e2e8f0; }
.tb-required { color: #f87171; font-size: 1.25rem; }
.tb-field-main { display: flex; flex-direction: column; gap: 0.5rem; }
.tb-field-main input[type="text"], .tb-field-main textarea, .tb-field-main select { width: 100%; padding: 0.875rem 1.125rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.75rem; color: #ffffff; font-size: 0.9375rem; transition: all 0.2s; }
.tb-field-main input[type="text"]:focus, .tb-field-main textarea:focus, .tb-field-main select:focus { outline: none; border-color: #c084fc; background: rgba(192, 132, 252, 0.1); box-shadow: 0 0 0 3px rgba(192, 132, 252, 0.1); }
.tb-field-main select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2394a3b8' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 1rem center; padding-right: 2.5rem; }
.tb-help-text { font-size: 0.875rem; color: #64748b; margin: 0; }
.tb-field-error { font-size: 0.875rem; color: #f87171; margin: 0; }
.tb-tags-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; margin: 0.75rem 0; }
.tb-tag-checkbox { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; font-size: 0.875rem; user-select: none; }
.tb-tag-checkbox:hover { background: rgba(255,255,255,0.06); border-color: rgba(192,132,252,0.4); transform: translateY(-1px); }
.tb-tag-checkbox input[type="checkbox"] { appearance: none; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer; position: relative; flex-shrink: 0; transition: all 0.2s; margin: 0; }
.tb-tag-checkbox input[type="checkbox"]:checked { background: linear-gradient(135deg, #c084fc, #7c3aed); border-color: #c084fc; }
.tb-tag-checkbox input[type="checkbox"]:checked::after { content: 'âœ“'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; font-weight: bold; }
.tb-tag-checkbox:has(input:checked) { background: rgba(192,132,252,0.15); border-color: #c084fc; }
.tb-tag-checkbox:has(input:checked) .tb-tag-label { color: #c084fc; font-weight: 600; }
.tb-upload-footer { display: flex; justify-content: flex-end; align-items: center; gap: 1rem; padding: 2rem 0; border-top: 1px solid rgba(255, 255, 255, 0.1); }
.tb-btn-cancel { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.875rem 1.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 0.75rem; color: #cbd5e1; font-size: 1rem; font-weight: 600; text-decoration: none; cursor: pointer; transition: all 0.2s; }
.tb-btn-cancel:hover { background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.25); color: #ffffff; transform: translateY(-1px); }
.tb-btn-submit { display: inline-flex; align-items: center; gap: 0.625rem; padding: 0.875rem 2rem; background: linear-gradient(135deg, #c084fc, #7c3aed); border: none; border-radius: 0.75rem; color: #ffffff; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(192, 132, 252, 0.3); }
.tb-btn-submit:hover:not(:disabled) { background: linear-gradient(135deg, #a855f7, #6d28d9); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(192, 132, 252, 0.4); }
.tb-btn-submit:disabled { opacity: 0.6; cursor: not-allowed; }
.tb-field-main select option {
  background: #1e1b4b;
  color: #ffffff;
}

/* ì²´í¬ëœ(ì„ íƒëœ) ì˜µì…˜ */
.tb-field-main select option:checked {
  background: #2563eb;
  color: #ffffff;
}
</style>
{% endblock %}