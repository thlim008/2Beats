<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>2Beats ì´ìƒí˜• ì›”ë“œì»µ</title>
    <style>
        /* --- [ê¸°ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€] --- */
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            text-align: center;
            padding: 20px;
        }

        h1 { margin-bottom: 10px; color: #00ff88; }
        .status-bar { font-size: 1.2rem; margin-bottom: 20px; color: #ccc; }

        /* ì„¤ì • í™”ë©´ */
        #setup-screen { display: block; margin-top: 100px; }
        select, .btn-start {
            padding: 10px 20px;
            font-size: 1rem;
            margin: 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        .btn-start { background-color: #00ff88; color: black; font-weight: bold; }
        .btn-start:hover { background-color: #00cc6a; }

        /* ì»¤ìŠ¤í…€ ì „ìš© ìŠ¤íƒ€ì¼ */
        .custom-title { font-size: 2rem; color: #ff99cc; margin-bottom: 10px; }
        .custom-creator { color: #aaa; margin-bottom: 30px; }

        /* ê²Œì„ í™”ë©´ ë ˆì´ì•„ì›ƒ (ê¸°ì¡´ê³¼ ë™ì¼) */
        #game-screen { display: none; width: 100%; }
        
        .versus-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
            margin-top: 30px;
        }

        .candidate-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .card {
            width: 320px;
            height: 420px;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border 0.2s;
            position: relative;
            border: 3px solid transparent;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            border-color: #555;
        }

        .card.playing-card {
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
            transform: scale(1.02);
        }

        .card img {
            width: 100%;
            height: 75%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .card-info {
            padding: 15px;
            background: linear-gradient(to top, #222, #333);
            height: 25%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .card-info h3 { margin: 0; font-size: 1.3rem; margin-bottom: 5px;}
        .card-info p { color: #aaa; margin: 0; }

        .play-icon {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: rgba(255,255,255,0.8);
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
            opacity: 0;
            transition: 0.3s;
        }
        .card:hover .play-icon { opacity: 1; }
        .playing-card .play-icon { opacity: 0; }

        .btn-select {
            padding: 15px 40px;
            font-size: 1.1rem;
            background-color: #444;
            color: white;
            border: 2px solid #555;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
        }
        .btn-select:hover {
            background-color: #00ff88;
            color: black;
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        .vs-text {
            font-size: 3rem;
            font-weight: bold;
            font-style: italic;
            color: #ff3333;
            margin-top: 180px;
        }

        audio { display: none; }

        #result-screen { display: none; margin-top: 50px; }
        .winner-card {
            margin: 0 auto 30px;
            transform: scale(1.2);
            border: 4px solid gold;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            width: 300px; 
            border-radius: 15px; 
            background: #222;
            padding: 10px;
        }
        .winner-card img { width: 100%; border-radius: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸµ 2Beats World Cup</h1>

    <div id="setup-screen">
        {% if is_custom %}
            <div class="custom-title">{{ custom_wc.title }}</div>
            <div class="custom-creator">Created by {{ custom_wc.creator.username }}</div>
            
            <p>ì´ {{ custom_wc.musics.count }}ê³¡ì´ ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
            <button class="btn-start" onclick="startCustomGame('{{ custom_wc.access_code }}', {{ custom_wc.musics.count }})">
                ğŸ”¥ ë„ì „í•˜ê¸°
            </button>
        {% else %}
            <h2>ê²Œì„ ì„¤ì •</h2>
            <div>
                <label>ì¥ë¥´: </label>
                <select id="genre-select">
                    <option value="all">ì „ì²´ ì¥ë¥´</option>
                    <option value="ballad">ë°œë¼ë“œ</option>
                    <option value="dance">ëŒ„ìŠ¤</option>
                    <option value="hiphop">í™í•©</option>
                    <option value="rnb">R&B</option>
                    <option value="indie">ì¸ë””</option>
                </select>
            </div>
            <div>
                <label>ëª¨ë“œ: </label>
                <select id="mode-select">
                    <option value="random">ëœë¤ ë§¤ì¹­</option>
                    <option value="rank">ë­í‚¹ ë§¤ì¹­ (ì¸ê¸°ê³¡)</option>
                </select>
            </div>
            <div>
                <label>ë¼ìš´ë“œ: </label>
                <select id="round-select">
                    <option value="16">16ê°•</option>
                    <option value="8">8ê°•</option>
                    <option value="4">4ê°•</option>
                </select>
            </div>
            <br>
            <button class="btn-start" onclick="startGame()">ê²Œì„ ì‹œì‘!</button>
        {% endif %}
    </div>

    <div id="game-screen">
        <div class="status-bar" id="round-info">16ê°• - 1 / 8</div>
        
        <div class="versus-container">
            <div class="candidate-wrapper">
                <div class="card" id="card-left" onclick="toggleAudio('left')">
                    <div class="play-icon">â–¶</div>
                    <img id="img-left" src="" alt="cover">
                    <div class="card-info">
                        <h3 id="title-left">Title</h3>
                        <p id="singer-left">Singer</p>
                    </div>
                </div>
                <button class="btn-select" onclick="selectMusic('left')">ğŸ‘† ì´ ê³¡ ì„ íƒ</button>
                <audio id="audio-left"></audio>
            </div>

            <div class="vs-text">VS</div>

            <div class="candidate-wrapper">
                <div class="card" id="card-right" onclick="toggleAudio('right')">
                    <div class="play-icon">â–¶</div>
                    <img id="img-right" src="" alt="cover">
                    <div class="card-info">
                        <h3 id="title-right">Title</h3>
                        <p id="singer-right">Singer</p>
                    </div>
                </div>
                <button class="btn-select" onclick="selectMusic('right')">ğŸ‘† ì´ ê³¡ ì„ íƒ</button>
                <audio id="audio-right"></audio>
            </div>

        </div>
        <p style="margin-top: 20px; color: #666;">â€» ì•¨ë²” ì»¤ë²„ë¥¼ í´ë¦­í•˜ë©´ ë¯¸ë¦¬ë“£ê¸°ê°€ ì¬ìƒë©ë‹ˆë‹¤.</p>
    </div>

    <div id="result-screen">
        <h2>ğŸ† ìµœì¢… ìš°ìŠ¹! ğŸ†</h2>
        <div class="winner-card">
            <img id="img-winner" src="" alt="cover">
            <div style="padding:15px;">
                <h3 id="title-winner" style="margin:0;color:white;"></h3>
                <p id="singer-winner" style="color:#aaa;margin:5px 0 0;"></p>
            </div>
        </div>
        <button class="btn-start" onclick="location.reload()">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>
</div>

<script>
    let candidates = [];
    let nextRound = [];
    let currentPairIndex = 0;
    let currentRoundName = 16;
    let gameHistory = [];
    
    // [ì¶”ê°€] í˜„ì¬ í”Œë ˆì´ ì¤‘ì¸ ì»¤ìŠ¤í…€ ì½”ë“œ ì €ì¥ìš©
    let currentCustomCode = null; 

    // 1. [ê¸°ì¡´] ì¼ë°˜ ê²Œì„ ì‹œì‘
    async function startGame() {
        const genre = document.getElementById('genre-select').value;
        const sort = document.getElementById('mode-select').value;
        const count = parseInt(document.getElementById('round-select').value);
        currentCustomCode = null; // ì¼ë°˜ ê²Œì„ì„

        await fetchAndStart(`/worldcup/candidates/?genre=${genre}&sort=${sort}&count=${count}`, count);
    }

    // 2. [ì¶”ê°€] ì»¤ìŠ¤í…€ ê²Œì„ ì‹œì‘
    async function startCustomGame(code, realCount) {
        currentCustomCode = code; 
        // count=100 ëŒ€ì‹  ì‹¤ì œ ê³¡ ìˆ˜(realCount)ë¥¼ ë„£ìŠµë‹ˆë‹¤.
        await fetchAndStart(`/worldcup/candidates/?custom_code=${code}&count=${realCount}`, realCount);
    }

    // [ê³µí†µ] ë°ì´í„° ê°€ì ¸ì™€ì„œ ê²Œì„ ì‹œì‘í•˜ê¸°
    async function fetchAndStart(url, explicitCount) {
        try {
            const response = await fetch(url);
            const data = await response.json();

            if (!response.ok) {
                alert(data.error || "ì˜¤ë¥˜ ë°œìƒ");
                return;
            }

            candidates = data.candidates;
            
            // ê³¡ ìˆ˜ì— ë§ì¶°ì„œ ë¼ìš´ë“œ ì´ë¦„ ì„¤ì • (ì˜ˆ: 12ê³¡ì´ë©´ -> 16ê°•ì€ ì•„ë‹ˆê³  ê·¸ëƒ¥ ì§„í–‰)
            // ê°„ë‹¨í•˜ê²Œ 2ì˜ ì œê³±ìˆ˜ë¡œ ë§ì¶”ê±°ë‚˜, ê·¸ëƒ¥ í˜„ì¬ ê°¯ìˆ˜ë¡œ ì‹œì‘
            currentRoundName = explicitCount || candidates.length; 
            
            // í™€ìˆ˜ë©´ ë¶€ì „ìŠ¹ ë¡œì§ì´ í•„ìš”í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ íŒ¨ìŠ¤ (ì„œë²„ê°€ ì§ìˆ˜ë¡œ ì£¼ê¸¸ ê¸°ëŒ€)

            nextRound = [];
            currentPairIndex = 0;
            gameHistory = [];

            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            updateDisplay();

        } catch (error) {
            console.error(error);
            alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
        }
    }

    // í™”ë©´ ì—…ë°ì´íŠ¸
    function updateDisplay() {
        stopAllAudio(); 

        const left = candidates[currentPairIndex];
        const right = candidates[currentPairIndex + 1];
        
        // ë” ì´ìƒ ëŒ€ê²°í•  ê³¡ì´ ì—†ìœ¼ë©´(í™€ìˆ˜ ë“±) -> ë¶€ì „ìŠ¹ ì²˜ë¦¬ (ê°„ë‹¨ êµ¬í˜„)
        if (!right) {
            nextRound.push(left);
            gameHistory.push({ music_id: left.id, rank: currentRoundName }); // ì„ì‹œ ë­í¬
            endRound();
            return;
        }

        const defaultImg = "https://via.placeholder.com/300x300?text=No+Image";

        document.getElementById('img-left').src = left.thumbnail_url || defaultImg;
        document.getElementById('title-left').textContent = left.music_title;
        document.getElementById('singer-left').textContent = left.music_singer;
        document.getElementById('audio-left').src = left.file_url || "";

        document.getElementById('img-right').src = right.thumbnail_url || defaultImg;
        document.getElementById('title-right').textContent = right.music_title;
        document.getElementById('singer-right').textContent = right.music_singer;
        document.getElementById('audio-right').src = right.file_url || "";

        // ìƒíƒœë°” ì—…ë°ì´íŠ¸
        const totalMatches = Math.floor(candidates.length / 2);
        const currentMatch = (currentPairIndex / 2) + 1;
        
        let roundText = `${candidates.length}ê°•`; 
        // ê°„ë‹¨í•œ í‘œê¸° (16, 8, 4, 2)
        if (candidates.length <= 2) roundText = "ê²°ìŠ¹ì „";
        else if (candidates.length <= 4) roundText = "4ê°•";
        else if (candidates.length <= 8) roundText = "8ê°•";
        else if (candidates.length <= 16) roundText = "16ê°•";

        document.getElementById('round-info').textContent = `${roundText} - ${currentMatch} / ${totalMatches}`;
    }

    function toggleAudio(side) {
        const targetAudio = document.getElementById(`audio-${side}`);
        const otherAudio = document.getElementById(`audio-${side === 'left' ? 'right' : 'left'}`);
        const targetCard = document.getElementById(`card-${side}`);
        const otherCard = document.getElementById(`card-${side === 'left' ? 'right' : 'left'}`);

        if (targetAudio.paused) {
            otherAudio.pause(); 
            otherAudio.currentTime = 0;
            otherCard.classList.remove('playing-card'); 

            targetAudio.play().catch(e => console.log("ì¬ìƒ ì‹¤íŒ¨:", e));
            targetCard.classList.add('playing-card'); 
        } else {
            targetAudio.pause();
            targetCard.classList.remove('playing-card'); 
        }
    }

    function stopAllAudio() {
        document.querySelectorAll('audio').forEach(a => {
            a.pause();
            a.currentTime = 0;
        });
        document.querySelectorAll('.card').forEach(c => {
            c.classList.remove('playing-card');
        });
    }

    function selectMusic(side) {
        stopAllAudio(); 

        const left = candidates[currentPairIndex];
        const right = candidates[currentPairIndex + 1];
        
        let winner, loser;
        if (side === 'left') {
            winner = left;
            loser = right;
        } else {
            winner = right;
            loser = left;
        }

        nextRound.push(winner);

        // ë­í‚¹ ì €ì¥ (ê²°ìŠ¹ì´ë©´ 2ë“±, ì•„ë‹ˆë©´ í˜„ì¬ ê°•ìˆ˜)
        const rank = (candidates.length <= 2) ? 2 : candidates.length;
        gameHistory.push({ music_id: loser.id, rank: rank });

        currentPairIndex += 2;

        if (currentPairIndex >= candidates.length) {
            endRound();
        } else {
            updateDisplay();
        }
    }

    function endRound() {
        if (candidates.length <= 2) {
            // ê²°ìŠ¹ ì¢…ë£Œ
            const finalWinner = nextRound[0];
            gameHistory.push({ music_id: finalWinner.id, rank: 1 });
            sendResultToServer(finalWinner);
        } else {
            // ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰
            candidates = nextRound;
            nextRound = [];
            currentPairIndex = 0;
            updateDisplay();
        }
    }

    async function sendResultToServer(winner) {
        try {
            const user_uid = "{% if user.is_authenticated %}{{ user.pk }}{% else %}{% endif %}";
            const final_uid = user_uid ? user_uid : null;

            // [ìˆ˜ì •] ì»¤ìŠ¤í…€ ì½”ë“œ(currentCustomCode)ë„ ê°™ì´ ì „ì†¡
            const response = await fetch('/worldcup/save/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_uid: final_uid,
                    total_rounds: 16, // ì»¤ìŠ¤í…€ì€ ë¼ìš´ë“œê°€ ê°€ë³€ì ì´ì§€ë§Œ ì¼ë‹¨ 16ìœ¼ë¡œ ê³ ì •í•˜ê±°ë‚˜ ë¡œì§ í•„ìš”
                    results: gameHistory,
                    custom_code: currentCustomCode // [ì¶”ê°€]
                })
            });

            const data = await response.json();
            if (response.ok) {
                window.location.href = `/worldcup/result/${data.game_id}/`;
            } else {
                alert("ì €ì¥ ì‹¤íŒ¨: " + JSON.stringify(data));
            }
        } catch (e) {
            console.error("ì €ì¥ ì¤‘ ì—ëŸ¬", e);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
        }
    }
</script>

</body>
</html>