<!-- templates/music_explore/search.html -->

{% extends 'music_explore/base.html' %}

{% block title %}ìŒì•… ê²€ìƒ‰ - TwoBeats{% endblock %}

{% block extra_css %}
<style>
    .autocomplete-container {
        position: relative;
    }
    
    .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: none;
        z-index: 100;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .autocomplete-results.active {
        display: block;
    }
    
    .autocomplete-item {
        padding: 0.8rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-bottom: 1px solid #eee;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    .autocomplete-item:hover {
        background-color: #f5f5f5;
    }
    
    .autocomplete-item.selected {
        background-color: #e8f5e9;
    }
    
    .autocomplete-type {
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        color: white;
    }
    
    .type-title {
        background-color: #1db954;
    }
    
    .type-singer {
        background-color: #3498db;
    }
</style>
{% endblock %}

{% block content %}
<h1 style="margin-bottom: 1.5rem;">ğŸ” ìŒì•… ê²€ìƒ‰</h1>

<!-- ê²€ìƒ‰ í¼ -->
<div class="card">
    <form method="GET" action="{% url 'music_explore:search' %}">
        <div class="autocomplete-container">
            <input 
                type="text" 
                name="q" 
                class="search-box"
                id="search-input"
                placeholder="ì œëª© ë˜ëŠ” ê°€ìˆ˜ë¡œ ê²€ìƒ‰..."
                value="{{ query }}"
                autocomplete="off"
            >
            <div class="autocomplete-results" id="autocomplete-results"></div>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
            <!-- ì¥ë¥´ í•„í„° -->
            <select name="genre" class="search-box" style="flex: 1; min-width: 150px;">
                <option value="">ì „ì²´ ì¥ë¥´</option>
                <option value="pop" {% if genre == 'pop' %}selected{% endif %}>Pop</option>
                <option value="ballad" {% if genre == 'ballad' %}selected{% endif %}>Ballad</option>
                <option value="hiphop" {% if genre == 'hiphop' %}selected{% endif %}>Hip-Hop</option>
                <option value="rnb" {% if genre == 'rnb' %}selected{% endif %}>R&B</option>
                <option value="rock" {% if genre == 'rock' %}selected{% endif %}>Rock</option>
                <option value="dance" {% if genre == 'dance' %}selected{% endif %}>Dance</option>
                <option value="indie" {% if genre == 'indie' %}selected{% endif %}>Indie</option>
            </select>
            
            <!-- íƒœê·¸ í•„í„° -->
            <select name="tag" class="search-box" style="flex: 1; min-width: 150px;">
                <option value="">ì „ì²´ íƒœê·¸</option>
                {% for t in all_tags %}
                    <option value="{{ t.name }}" {% if tag == t.name %}selected{% endif %}>#{{ t.name }}</option>
                {% endfor %}
            </select>
            
            <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
        </div>
    </form>
</div>

<!-- ê²€ìƒ‰ ê²°ê³¼ -->
<div class="card">
    <h2 style="margin-bottom: 1rem;">
        ê²€ìƒ‰ ê²°ê³¼ 
        <span style="color: #666; font-size: 1rem;">({{ musics.paginator.count }}ê³¡)</span>
    </h2>
    
    {% if musics %}
        <div style="display: grid; gap: 1rem;">
            {% for music in musics %}
                <div style="
                    display: flex;
                    align-items: center;
                    padding: 1rem;
                    background-color: #f9f9f9;
                    border-radius: 8px;
                    gap: 1rem;
                ">
                    <!-- ì¸ë„¤ì¼ -->
                    <div style="min-width: 60px;">
                        {% if music.music_thumbnail %}
                            <img src="{{ music.music_thumbnail.url }}" 
                                 style="width: 60px; height: 60px; border-radius: 4px; object-fit: cover;">
                        {% else %}
                            <div style="
                                width: 60px; 
                                height: 60px; 
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                border-radius: 4px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 1.5rem;
                            ">ğŸµ</div>
                        {% endif %}
                    </div>
                    
                    <!-- ì •ë³´ -->
                    <div style="flex: 1;">
                        <a href="{% url 'music_explore:detail' music.id %}" 
                           style="font-weight: bold; color: #333; text-decoration: none;">
                            {{ music.music_title }}
                        </a>
                        <p style="color: #666; font-size: 0.9rem;">{{ music.music_singer }}</p>
                    </div>
                    
                    <!-- ì¬ìƒ ë²„íŠ¼ -->
                    {% if music.music_root %}
                    <button 
                        class="btn btn-primary"
                        data-id="{{ music.id }}"
                        data-title="{{ music.music_title }}"
                        data-singer="{{ music.music_singer }}"
                        data-url="{{ music.music_root.url }}"
                        data-thumb="{% if music.music_thumbnail %}{{ music.music_thumbnail.url }}{% endif %}"
                        onclick="playMusicFromData(this)"
                    >
                        â–¶ï¸
                    </button>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        
        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        {% if musics.has_other_pages %}
        <div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem;">
            {% if musics.has_previous %}
                <a href="?q={{ query }}&genre={{ genre }}&tag={{ tag }}&page=1" class="btn btn-secondary">ì²˜ìŒ</a>
                <a href="?q={{ query }}&genre={{ genre }}&tag={{ tag }}&page={{ musics.previous_page_number }}" class="btn btn-secondary">ì´ì „</a>
            {% endif %}
            
            <span class="btn btn-primary">{{ musics.number }} / {{ musics.paginator.num_pages }}</span>
            
            {% if musics.has_next %}
                <a href="?q={{ query }}&genre={{ genre }}&tag={{ tag }}&page={{ musics.next_page_number }}" class="btn btn-secondary">ë‹¤ìŒ</a>
                <a href="?q={{ query }}&genre={{ genre }}&tag={{ tag }}&page={{ musics.paginator.num_pages }}" class="btn btn-secondary">ë§ˆì§€ë§‰</a>
            {% endif %}
        </div>
        {% endif %}
    {% else %}
        <p style="text-align: center; color: #999; padding: 2rem;">
            ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
        </p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
const searchInput = document.getElementById('search-input');
const autocompleteResults = document.getElementById('autocomplete-results');
let selectedIndex = -1;
let debounceTimer;

// ì…ë ¥ ì‹œ ìë™ì™„ì„±
searchInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    const query = this.value.trim();
    
    if (query.length < 1) {
        autocompleteResults.classList.remove('active');
        return;
    }
    
    // 300ms í›„ì— ê²€ìƒ‰ (íƒ€ì´í•‘ ì¤‘ì—ëŠ” ìš”ì²­ ì•ˆ í•¨)
    debounceTimer = setTimeout(() => {
        fetch(`/music/autocomplete/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.results.length > 0) {
                    renderAutocomplete(data.results);
                } else {
                    autocompleteResults.classList.remove('active');
                }
            });
    }, 300);
});

// ìë™ì™„ì„± ë Œë”ë§
function renderAutocomplete(results) {
    selectedIndex = -1;
    autocompleteResults.innerHTML = results.map((item, index) => `
        <div class="autocomplete-item" data-value="${item.value}" data-index="${index}">
            <span class="autocomplete-type ${item.type === 'title' ? 'type-title' : 'type-singer'}">
                ${item.type === 'title' ? 'ì œëª©' : 'ê°€ìˆ˜'}
            </span>
            <span>${item.value}</span>
        </div>
    `).join('');
    
    autocompleteResults.classList.add('active');
    
    // í´ë¦­ ì´ë²¤íŠ¸
    document.querySelectorAll('.autocomplete-item').forEach(item => {
        item.addEventListener('click', function() {
            searchInput.value = this.dataset.value;
            autocompleteResults.classList.remove('active');
            searchInput.closest('form').submit();
        });
    });
}

// í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
searchInput.addEventListener('keydown', function(e) {
    const items = document.querySelectorAll('.autocomplete-item');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
        updateSelected(items);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelected(items);
    } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        searchInput.value = items[selectedIndex].dataset.value;
        autocompleteResults.classList.remove('active');
        searchInput.closest('form').submit();
    } else if (e.key === 'Escape') {
        autocompleteResults.classList.remove('active');
    }
});

function updateSelected(items) {
    items.forEach((item, index) => {
        if (index === selectedIndex) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

// ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !autocompleteResults.contains(e.target)) {
        autocompleteResults.classList.remove('active');
    }
});
</script>
{% endblock %}