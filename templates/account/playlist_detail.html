{% extends "music_explore/base.html" %}
{% block title %}í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ | 2beats{% endblock %}

{% block extra_css %}
<style>
    /* ë¦¬ìŠ¤íŠ¸ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§Œ ë‚¨ê¹€ */
    .btn-play-all {
        display: inline-flex; align-items: center; gap: 8px;
        background: linear-gradient(135deg, #c084fc, #7c3aed);
        color: white; border: none; padding: 10px 20px;
        border-radius: 24px; font-weight: 700; cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 15px rgba(124,58,237,0.3);
    }
    .btn-play-all:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(124,58,237,0.4); }
    
    .btn-list-play {
        width: 32px; height: 32px; border-radius: 50%;
        background: rgba(192,132,252,0.15); color: #c084fc;
        border: 1px solid rgba(192,132,252,0.3);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.2s; padding-left: 3px;
    }
    .btn-list-play:hover { background: #c084fc; color: #0b1220; }
    
    /* ì¬ìƒ ì¤‘ì¸ í–‰ ê°•ì¡° */
    .playing-row { background: rgba(192,132,252,0.15) !important; }
</style>
{% endblock %}

{% block content %}

<div class="card" style="margin-bottom:14px;">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
        <div>
            <p class="pill-label" style="margin:0 0 8px;">{% if is_music %}ìŒì•…{% else %}ì˜ìƒ{% endif %} í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</p>
            <h1 style="margin:0 0 6px;">{{ playlist.folder_name }}</h1>
            <p class="muted" style="margin:0;">ì´ {{ items.count }}ê³¡ | ìƒì„±ì¼ {{ playlist.created_at|date:"Y-m-d" }}</p>
        </div>
        
        {% if is_music and items %}
        <div>
            <button class="btn-play-all" onclick="playAllItems()">
                <span style="font-size:1.1rem;">â–¶</span> ì „ì²´ ì¬ìƒ
            </button>
        </div>
        {% endif %}
    </div>
</div>

<div class="card" style="margin-bottom:100px;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
        <h3 style="margin:0;">íŠ¸ë™ ëª©ë¡</h3>
        {% if items %}
            <span class="muted">ìˆœì„œë¥¼ ë³€ê²½í•˜ë ¤ë©´ ìˆ«ìë¥¼ ìˆ˜ì •í•˜ê³  ì €ì¥ì„ ëˆ„ë¥´ì„¸ìš”.</span>
        {% endif %}
    </div>

    {% if items %}
    <form method="post" action="">
        {% csrf_token %}
        <input type="hidden" name="action" value="reorder">
        <table>
            <thead>
                <tr>
                    <th style="width: 50px; text-align:center;"></th>
                    <th style="width: 70px;">ìˆœì„œ</th>
                    <th>ì œëª©</th>
                    <th>ì•„í‹°ìŠ¤íŠ¸</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr id="track-row-{{ item.music.id }}"> <td style="text-align:center;">
                        {% if is_music and item.music.music_root %}
                        <button type="button" class="btn-list-play" 
                                onclick="playSpecificItem({{ forloop.counter0 }})">â–¶</button>
                        {% endif %}
                    </td>
                    <td>
                        <input type="number" name="order_{{ item.id }}" value="{{ item.order }}" min="1" 
                               style="width:50px; padding:6px; border-radius:8px; border:1px solid var(--border); background:#0c0a18; color:var(--text); text-align:center;">
                    </td>
                    <td>
                        {% if is_music %}
                            <a href="{% url 'music_explore:detail' item.music.id %}" style="font-weight:bold; color:var(--text);">{{ item.music.music_title }}</a>
                        {% else %}
                            <a href="{% url 'video_explore:video_detail' item.video.id %}" style="font-weight:bold; color:var(--text);">{{ item.video.video_title }}</a>
                        {% endif %}
                    </td>
                    <td class="muted">
                        {% if is_music %}
                            {{ item.music.music_singer }}
                        {% else %}
                            {{ item.video.video_singer }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="margin-top:16px; text-align:right;">
            <button type="submit" class="btn btn-primary" style="border:none;">ìˆœì„œ ì €ì¥</button>
        </div>
    </form>
    {% else %}
    <div style="text-align:center; padding:40px 0; color:#999;">
        <p style="font-size:2rem; margin-bottom:10px;">ğŸ“­</p>
        <p>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    // 1. í˜„ì¬ í˜ì´ì§€ì˜ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ JS ë°°ì—´ë¡œ ë³€í™˜
    // (ë¶€ëª¨ í…œí”Œë¦¿ì˜ ì „ì—­ 'playlist' ë³€ìˆ˜ë¥¼ ë®ì–´ì“°ê¸° ìœ„í•¨)
    const currentListItems = [
      {% for item in items %}
        {% if is_music and item.music.music_root %}
        {
            id: {{ item.music.id }},
            title: "{{ item.music.music_title|escapejs }}",
            artist: "{{ item.music.music_singer|escapejs }}",
            url: "{{ item.music.music_root.url }}",
            thumbnail: "{% if item.music.music_thumbnail %}{{ item.music.music_thumbnail.url }}{% endif %}"
        },
        {% endif %}
      {% endfor %}
    ];

    // 2. ì „ì²´ ì¬ìƒ í•¨ìˆ˜
    function playAllItems() {
        if (currentListItems.length === 0) {
            alert("ì¬ìƒí•  ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        
        // ë¶€ëª¨ í…œí”Œë¦¿(base.html)ì˜ ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
        playlist = currentListItems; 
        currentIndex = 0;
        isShuffled = false; // ì „ì²´ ì¬ìƒ ì‹œ ì…”í”Œ ì´ˆê¸°í™” (ì„ íƒì‚¬í•­)

        // ì²« ê³¡ ì¬ìƒ (ë¶€ëª¨ í…œí”Œë¦¿ì˜ playMusic í•¨ìˆ˜ í˜¸ì¶œ)
        const track = playlist[0];
        playMusic(track.id, track.title, track.artist, track.url, track.thumbnail);
        
        // UI í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸
        updateActiveRow(track.id);
    }

    // 3. ê°œë³„ ê³¡ ì¬ìƒ í•¨ìˆ˜ (ë¦¬ìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ ìœ ì§€)
    function playSpecificItem(index) {
        if (index < 0 || index >= currentListItems.length) return;

        // ë¶€ëª¨ í…œí”Œë¦¿ì˜ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ í˜„ì¬ ë¦¬ìŠ¤íŠ¸ë¡œ êµì²´
        playlist = currentListItems;
        currentIndex = index;

        const track = playlist[index];
        playMusic(track.id, track.title, track.artist, track.url, track.thumbnail);
        
        updateActiveRow(track.id);
    }

    // 4. í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ê³¡ í•˜ì´ë¼ì´íŠ¸ í‘œì‹œ
    function updateActiveRow(musicId) {
        // ëª¨ë“  row ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
        document.querySelectorAll('tbody tr').forEach(tr => tr.classList.remove('playing-row'));
        
        // í˜„ì¬ ê³¡ row ì°¾ì•„ì„œ ê°•ì¡°
        const row = document.getElementById(`track-row-${musicId}`);
        if(row) row.classList.add('playing-row');
    }

    // (ì˜µì…˜) ë¶€ëª¨ í…œí”Œë¦¿ì˜ playMusic í•¨ìˆ˜ê°€ í˜¸ì¶œë  ë•Œë§ˆë‹¤ í•˜ì´ë¼ì´íŠ¸ ê°±ì‹ í•˜ê³  ì‹¶ë‹¤ë©´
    // MutationObserverë‚˜ CustomEventë¥¼ ì¨ì•¼ í•˜ì§€ë§Œ, 
    // ì—¬ê¸°ì„œëŠ” ë²„íŠ¼ í´ë¦­ ì‹œì ì—ë§Œ ê°±ì‹ í•˜ë„ë¡ ê°„ë‹¨íˆ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.
</script>
{% endblock %}