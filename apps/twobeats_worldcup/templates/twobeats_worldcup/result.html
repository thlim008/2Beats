<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì›”ë“œì»µ ê²°ê³¼ - 2Beats</title>
    <style>
        /* --- [ê³µí†µ ìŠ¤íƒ€ì¼] --- */
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #121212;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 800px;
            text-align: center;
            padding: 40px 20px;
        }

        /* ìš°ìŠ¹ì ì¹´ë“œ (ê¸ˆìƒ‰ í…Œë‘ë¦¬ íš¨ê³¼) */
        .winner-section {
            margin-bottom: 50px;
            animation: popUp 0.8s ease-out;
        }
        .winner-badge {
            font-size: 1.5rem;
            color: #ffd700;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            font-weight: bold;
        }
        .winner-card {
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            border-radius: 20px;
            padding: 5px; /* í…Œë‘ë¦¬ ë‘ê»˜ */
            background-image: linear-gradient(45deg, #ffd700, #ffaa00, #ffd700); /* ê¸ˆìƒ‰ ê·¸ë¼ë°ì´ì…˜ */
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.3);
            display: inline-block;
        }
        .winner-content {
            background: #222;
            border-radius: 18px;
            padding: 20px;
            width: 300px;
        }
        .winner-img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .winner-title { font-size: 1.5rem; margin: 10px 0; color: white; font-weight: bold; }
        .winner-singer { color: #aaa; font-size: 1.1rem; margin: 0; }

        /* ë‚˜ë¨¸ì§€ ìˆœìœ„ ë¦¬ìŠ¤íŠ¸ */
        h3 { color: #00ff88; margin-top: 40px; margin-bottom: 20px; text-align: left;}

        .rank-list {
            list-style: none;
            padding: 0;
            width: 100%;
            text-align: left;
        }
        .rank-item {
            background: #1e1e1e;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid #333;
            transition: transform 0.2s;
        }
        .rank-item:hover { transform: translateX(5px); background: #2a2a2a; border-color: #555; }
        
        .rank-num {
            font-size: 1.2rem;
            font-weight: bold;
            width: 50px;
            text-align: center;
        }
        .rank-2 { color: #c0c0c0; } /* ì€ìƒ‰ */
        .rank-4 { color: #cd7f32; } /* ë™ìƒ‰ */
        
        .mini-thumb {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            object-fit: cover;
            background: #333;
        }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group {
            margin-top: 40px;
            margin-bottom: 60px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        button {
            padding: 15px 30px;
            font-size: 1rem;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            text-decoration: none;
        }
        .btn-save { 
            background-color: #3b82f6; /* íŒŒë€ìƒ‰ */
            color: white; 
            border: 1px solid #2563eb;
        }
        .btn-save:hover { background-color: #2563eb; }
        .btn-retry { background-color: #00ff88; color: black; }
        .btn-retry:hover { background-color: #00cc6a; }
        .btn-ranking { background-color: #333; color: white; border: 1px solid #555; }
        .btn-ranking:hover { background-color: #444; border-color: #777; }

        @keyframes popUp {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="winner-section">
        <div class="winner-badge">ğŸ‘‘ ìµœì¢… ìš°ìŠ¹ (Winner)</div>
        <div class="winner-card">
            <div class="winner-content">
                {% if winner.wc_music.music_thumbnail %}
                    <img class="winner-img" src="{{ winner.wc_music.music_thumbnail.url }}" alt="winner">
                {% else %}
                    <div class="winner-img" style="background:#333;display:flex;align-items:center;justify-content:center;color:#666;">No Image</div>
                {% endif %}
                
                <h2 class="winner-title">{{ winner.wc_music.music_title }}</h2>
                <p class="winner-singer">{{ winner.wc_music.music_singer }}</p>
            </div>
        </div>
    </div>

    <h3>ğŸ“œ í”Œë ˆì´ íˆìŠ¤í† ë¦¬</h3>
    <ul class="rank-list">
        {% for result in others %}
        <li class="rank-item">
            <div class="rank-num rank-{{ result.wc_final_rank }}">
                {% if result.wc_final_rank == 2 %}ğŸ¥ˆ
                {% elif result.wc_final_rank == 4 %}ğŸ¥‰
                {% else %}{{ result.wc_final_rank }}ê°•
                {% endif %}
            </div>
            
            {% if result.wc_music.music_thumbnail %}
                <img class="mini-thumb" src="{{ result.wc_music.music_thumbnail.url }}" alt="thumb">
            {% else %}
                <div class="mini-thumb" style="display:flex;align-items:center;justify-content:center;font-size:0.7rem;">No Img</div>
            {% endif %}

            <div>
                <div style="font-weight: bold;">{{ result.wc_music.music_title }}</div>
                <div style="font-size: 0.9rem; color: #aaa;">{{ result.wc_music.music_singer }}</div>
            </div>
        </li>
        {% empty %}
        <p style="color:#666; text-align:center; padding:20px;">ë‹¤ë¥¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
    </ul>

{% if recommendations %}
    <h3 style="color: #ff99cc; margin-top: 50px;">ğŸ‘¥ ì´ ê³¡ì„ ë½‘ì€ ë¶„ë“¤ì€ ì´ëŸ° ê³¡ë„ ì¢‹ì•„í•´ìš”</h3>
    <ul class="rank-list">
        {% for music in recommendations %}
        <li class="rank-item" style="border-color: #ff99cc;">
            <div class="rank-num" style="font-size: 1.5rem;">ğŸ‘</div>
            
            {% if music.music_thumbnail %}
                <img class="mini-thumb" src="{{ music.music_thumbnail.url }}" alt="thumb">
            {% else %}
                <div class="mini-thumb" style="display:flex;align-items:center;justify-content:center;font-size:0.7rem;">No Img</div>
            {% endif %}

            <div>
                <div style="font-weight: bold;">{{ music.music_title }}</div>
                <div style="font-size: 0.9rem; color: #aaa;">{{ music.music_singer }}</div>
            </div>
            
            <div style="margin-left: auto; background: #333; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; color: #ccc;">
                {{ music.get_music_type_display }}
            </div>
        </li>
        {% endfor %}
    </ul>
    {% endif %}

    <div class="btn-group">
        <button class="btn-retry" onclick="location.href='{% url 'twobeats_worldcup:play' %}'">ğŸ”„ ë‹¤ì‹œ í•˜ê¸°</button>
        
        {% if user.is_authenticated %}
            <button class="btn-save" onclick="saveToPlaylist()">ğŸ’¾ ê²°ê³¼ ì €ì¥</button>
        {% else %}
             <button class="btn-save" onclick="alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!')" style="opacity: 0.6;">ğŸ’¾ ê²°ê³¼ ì €ì¥</button>
        {% endif %}
        
        <button class="btn-ranking" onclick="location.href='{% url 'twobeats_worldcup:ranking' %}'">ğŸ† ë­í‚¹ ë³´ê¸°</button>
    </div>
</div>

<script>
    // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì €ì¥ ìš”ì²­ í•¨ìˆ˜
    async function saveToPlaylist() {
        const gameId = "{{ game.pk }}"; // í˜„ì¬ ê²Œì„ ID
        
        if (!confirm("í˜„ì¬ 4ê°• ì´ìƒ ì§„ì¶œí•œ ê³¡ë“¤ì„\në‚´ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
        }

        try {
            // CSRF í† í° ê°€ì ¸ì˜¤ê¸° (Django ë³´ì•ˆ í•„ìˆ˜)
            const getCookie = (name) => {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            const response = await fetch(`/worldcup/save_playlist/${gameId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            });

            const data = await response.json();

            if (response.ok) {
                alert(data.message); // "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!"
                // í•„ìš”í•˜ë‹¤ë©´ ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™
                // location.href = '/account/playlists/'; 
            } else {
                alert("ì €ì¥ ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
            }

        } catch (error) {
            console.error(error);
            alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }
</script>

</body>
</html>