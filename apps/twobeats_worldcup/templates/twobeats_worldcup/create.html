<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‚˜ë§Œì˜ ì›”ë“œì»µ ë§Œë“¤ê¸°</title>
    <style>
        body { background-color: #121212; color: white; font-family: sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        input[type="text"] { width: 100%; padding: 10px; margin-bottom: 20px; background: #333; border: 1px solid #555; color: white; }
        
        .music-list { height: 400px; overflow-y: scroll; border: 1px solid #333; padding: 10px; }
        .music-item { display: flex; align-items: center; padding: 5px; border-bottom: 1px solid #222; }
        .music-item:hover { background: #1e1e1e; }
        .thumb { width: 40px; height: 40px; margin-right: 10px; object-fit: cover; border-radius: 4px; }
        
        .btn-create { width: 100%; padding: 15px; background: #00ff88; border: none; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1.1rem; }
        .btn-create:hover { background: #00cc6a; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ› ï¸ ë‚˜ë§Œì˜ ì›”ë“œì»µ ë§Œë“¤ê¸°</h1>
    
    <label>ì›”ë“œì»µ ì œëª©</label>
    <input type="text" id="wc-title" placeholder="ì˜ˆ: ì•„ì´ìœ  ë°œë¼ë“œ ëª¨ìŒ (ìµœì†Œ 4ê³¡ ì´ìƒ ì„ íƒ)">

    <label>í›„ë³´ê³¡ ì„ íƒ (ì²´í¬ë°•ìŠ¤)</label>
    <div class="music-list">
        {% for music in musics %}
        <div class="music-item">
            <input type="checkbox" class="music-checkbox" value="{{ music.id }}" style="margin-right: 15px;">
            
            {% if music.music_thumbnail %}
                <img src="{{ music.music_thumbnail.url }}" class="thumb">
            {% else %}
                <div class="thumb" style="background:#333;"></div>
            {% endif %}
            
            <div>
                <div>{{ music.music_title }}</div>
                <div style="font-size:0.8rem; color:#888;">{{ music.music_singer }}</div>
            </div>
        </div>
        {% endfor %}
    </div>

    <button class="btn-create" onclick="submitWorldCup()">ì›”ë“œì»µ ìƒì„±í•˜ê¸°</button>
</div>

<script>
    async function submitWorldCup() {
        const title = document.getElementById('wc-title').value;
        
        // ì²´í¬ëœ ë°•ìŠ¤ë“¤ì˜ ê°’ì„ ë°°ì—´ë¡œ ê°€ì ¸ì˜¤ê¸°
        const checkboxes = document.querySelectorAll('.music-checkbox:checked');
        const musicIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

        if (!title.trim()) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        if (musicIds.length < 4) return alert("ìµœì†Œ 4ê³¡ ì´ìƒ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");

        try {
            // CSRF í† í° (Django ê¸°ë³¸)
            const getCookie = (name) => {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            // API í˜¸ì¶œ (POST)
            const response = await fetch('/worldcup/api/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    title: title,
                    music_ids: musicIds
                })
            });

            const data = await response.json();

            if (response.ok) {
                alert("ìƒì„± ì™„ë£Œ! ê³µìœ  URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n(í™•ì¸ í´ë¦­ ì‹œ í•´ë‹¹ ê²Œì„ìœ¼ë¡œ ì´ë™)");
                // í´ë¦½ë³´ë“œ ë³µì‚¬ (ì„ íƒì‚¬í•­)
                navigator.clipboard.writeText(window.location.origin + data.share_url);
                // ê²Œì„ í˜ì´ì§€ë¡œ ì´ë™ (URLì— ìƒì„±ëœ ì½”ë“œê°€ ìˆë‹¤ê³  ê°€ì •)
                window.location.href = data.share_url;
            } else {
                alert("ì˜¤ë¥˜: " + (data.error || JSON.stringify(data)));
            }

        } catch (e) {
            console.error(e);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
        }
    }
</script>

</body>
</html>