<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>2Beats ì´ìƒí˜• ì›”ë“œì»µ</title>
    <style>
        /* --- [CSS ìŠ¤íƒ€ì¼] --- */
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            text-align: center;
            padding: 20px;
        }

        h1 { margin-bottom: 10px; color: #00ff88; }
        .status-bar { font-size: 1.2rem; margin-bottom: 20px; color: #ccc; }

        /* ì„¤ì • í™”ë©´ */
        #setup-screen { display: block; margin-top: 100px; }
        select, button {
            padding: 10px 20px;
            font-size: 1rem;
            margin: 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        button { background-color: #00ff88; color: black; font-weight: bold; }
        button:hover { background-color: #00cc6a; }

        /* ê²Œì„ í™”ë©´ */
        #game-screen { display: none; width: 100%; }
        .versus-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 50px;
            margin-top: 30px;
        }
        
        .card {
            width: 300px;
            height: 400px;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            border: 2px solid #00ff88;
        }
        .card img {
            width: 100%;
            height: 70%;
            object-fit: cover;
        }
        .card-info {
            padding: 15px;
        }
        .card-info h3 { margin: 0; font-size: 1.2rem; }
        .card-info p { color: #aaa; margin: 5px 0 0; }

        .vs-text {
            font-size: 3rem;
            font-weight: bold;
            font-style: italic;
            color: #ff3333;
        }

        /* ê²°ê³¼ í™”ë©´ */
        #result-screen { display: none; margin-top: 50px; }
        .winner-card {
            margin: 0 auto 30px;
            transform: scale(1.2);
            border: 4px solid gold;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸµ 2Beats World Cup</h1>

    <div id="setup-screen">
        <h2>ê²Œì„ ì„¤ì •</h2>
        <div>
            <label>ì¥ë¥´: </label>
            <select id="genre-select">
                <option value="all">ì „ì²´ ì¥ë¥´</option>
                <option value="ballad">ë°œë¼ë“œ</option>
                <option value="dance">ëŒ„ìŠ¤</option>
                <option value="hiphop">í™í•©</option>
                <option value="rnb">R&B</option>
                <option value="indie">ì¸ë””</option>
            </select>
        </div>
        <div>
            <label>ëª¨ë“œ: </label>
            <select id="mode-select">
                <option value="random">ëœë¤ ë§¤ì¹­</option>
                <option value="rank">ë­í‚¹ ë§¤ì¹­ (ì¸ê¸°ê³¡)</option>
            </select>
        </div>
        <div>
            <label>ë¼ìš´ë“œ: </label>
            <select id="round-select">
                <option value="16">16ê°•</option>
                <option value="32">32ê°•</option>
            </select>
        </div>
        <br>
        <button onclick="startGame()">ê²Œì„ ì‹œì‘!</button>
    </div>

    <div id="game-screen">
        <div class="status-bar" id="round-info">16ê°• - 1 / 8</div>
        
        <div class="versus-container">
            <div class="card" onclick="selectMusic('left')">
                <img id="img-left" src="" alt="cover">
                <div class="card-info">
                    <h3 id="title-left">ë…¸ë˜ ì œëª©</h3>
                    <p id="singer-left">ê°€ìˆ˜</p>
                </div>
            </div>

            <div class="vs-text">VS</div>

            <div class="card" onclick="selectMusic('right')">
                <img id="img-right" src="" alt="cover">
                <div class="card-info">
                    <h3 id="title-right">ë…¸ë˜ ì œëª©</h3>
                    <p id="singer-right">ê°€ìˆ˜</p>
                </div>
            </div>
        </div>
        
        <audio id="bgm-player" controls style="display:none;"></audio>
    </div>

    <div id="result-screen">
        <h2>ğŸ† ìµœì¢… ìš°ìŠ¹! ğŸ†</h2>
        <div class="card winner-card">
            <img id="img-winner" src="" alt="cover">
            <div class="card-info">
                <h3 id="title-winner"></h3>
                <p id="singer-winner"></p>
            </div>
        </div>
        <button onclick="location.reload()">ë‹¤ì‹œ í•˜ê¸°</button>
        <button class="btn-share" onclick="location.href='{% url 'twobeats_worldcup:ranking' %}'" style="background-color: #333;">ğŸ† ë­í‚¹ ë³´ê¸°</button>
    </div>
</div>

<script>
    /* --- [JS ê²Œì„ ë¡œì§] --- */
    let candidates = [];   // ì „ì²´ í›„ë³´
    let nextRound = [];    // ë‹¤ìŒ ë¼ìš´ë“œ ì§„ì¶œì
    let currentPairIndex = 0; // í˜„ì¬ ë§¤ì¹˜ ì¸ë±ìŠ¤
    let currentRoundName = 16; // 16ê°•, 8ê°•...
    
    // ì´ë ¥ ì €ì¥ìš© (ì„œë²„ ì „ì†¡)
    let gameHistory = []; 

    // 1. ê²Œì„ ì‹œì‘ (API í˜¸ì¶œ)
    async function startGame() {
        const genre = document.getElementById('genre-select').value;
        const sort = document.getElementById('mode-select').value;
        const count = parseInt(document.getElementById('round-select').value);

        try {
            // API í˜¸ì¶œ
            const response = await fetch(`/worldcup/candidates/?genre=${genre}&sort=${sort}&count=${count}`);
            const data = await response.json();

            if (!response.ok) {
                alert(data.error || "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            candidates = data.candidates;
            currentRoundName = count;
            nextRound = [];
            currentPairIndex = 0;
            gameHistory = [];

            // í™”ë©´ ì „í™˜
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            updateDisplay();

        } catch (error) {
            console.error(error);
            alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨!");
        }
    }

    // 2. í™”ë©´ ì—…ë°ì´íŠ¸ (ì¹´ë“œ ë³´ì—¬ì£¼ê¸°)
    function updateDisplay() {
        const left = candidates[currentPairIndex];
        const right = candidates[currentPairIndex + 1];

        // ì´ë¯¸ì§€ ì—†ì„ ë•Œ ê¸°ë³¸ ì´ë¯¸ì§€ ì²˜ë¦¬
        const defaultImg = "https://via.placeholder.com/300x300?text=No+Image";

        document.getElementById('img-left').src = left.thumbnail_url || defaultImg;
        document.getElementById('title-left').textContent = left.music_title;
        document.getElementById('singer-left').textContent = left.music_singer;

        document.getElementById('img-right').src = right.thumbnail_url || defaultImg;
        document.getElementById('title-right').textContent = right.music_title;
        document.getElementById('singer-right').textContent = right.music_singer;

        // ìƒíƒœë°” ì—…ë°ì´íŠ¸
        const totalMatches = candidates.length / 2;
        const currentMatch = (currentPairIndex / 2) + 1;
        
        let roundText = `${currentRoundName}ê°•`;
        if (currentRoundName === 2) roundText = "ê²°ìŠ¹ì „";
        
        document.getElementById('round-info').textContent = `${roundText} - ${currentMatch} / ${totalMatches}`;
    }

    // 3. ì„ íƒ í•¸ë“¤ëŸ¬
    function selectMusic(side) {
        const left = candidates[currentPairIndex];
        const right = candidates[currentPairIndex + 1];
        
        let winner, loser;
        
        if (side === 'left') {
            winner = left;
            loser = right;
        } else {
            winner = right;
            loser = left;
        }

        // ìŠ¹ì -> ë‹¤ìŒ ë¼ìš´ë“œ ëŒ€ê¸°ì—´
        nextRound.push(winner);

        // íŒ¨ì -> ê¸°ë¡ ì €ì¥ (í˜„ì¬ ë¼ìš´ë“œê°€ ê³§ ë“±ìˆ˜)
        // ê²°ìŠ¹(2ê°•) íŒ¨ìëŠ” 2ë“±, ë‚˜ë¨¸ì§€ëŠ” 16ê°•, 8ê°•...
        const rank = currentRoundName === 2 ? 2 : currentRoundName;
        gameHistory.push({ music_id: loser.id, rank: rank });

        // ë‹¤ìŒ ë§¤ì¹˜ë¡œ ì´ë™
        currentPairIndex += 2;

        // ë¼ìš´ë“œ ì¢…ë£Œ ì²´í¬
        if (currentPairIndex >= candidates.length) {
            endRound();
        } else {
            updateDisplay();
        }
    }

    // 4. ë¼ìš´ë“œ ì¢…ë£Œ ì²˜ë¦¬
    function endRound() {
        if (currentRoundName === 2) {
            // [ê²Œì„ ì¢…ë£Œ] ìš°ìŠ¹ì ì²˜ë¦¬
            const finalWinner = nextRound[0];
            
            // ìš°ìŠ¹ì(1ë“±) ê¸°ë¡ ì¶”ê°€
            gameHistory.push({ music_id: finalWinner.id, rank: 1 });
            
            showResult(finalWinner);
            sendResultToServer(); // ê²°ê³¼ ì„œë²„ ì „ì†¡
        } else {
            // [ë‹¤ìŒ ë¼ìš´ë“œ ì§„ì¶œ]
            candidates = nextRound;
            nextRound = [];
            currentPairIndex = 0;
            currentRoundName = currentRoundName / 2;
            updateDisplay();
        }
    }

    // 5. ê²°ê³¼ í™”ë©´ ë³´ì—¬ì£¼ê¸°
    function showResult(winner) {
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';

        const defaultImg = "https://via.placeholder.com/300x300?text=No+Image";
        document.getElementById('img-winner').src = winner.thumbnail_url || defaultImg;
        document.getElementById('title-winner').textContent = winner.music_title;
        document.getElementById('singer-winner').textContent = winner.music_singer;
    }

    // 6. ê²°ê³¼ ì„œë²„ ì „ì†¡ (POST)
    async function sendResultToServer() {
        try {
            // ë¡œê·¸ì¸ ìœ ì € UID ê°€ì ¸ì˜¤ê¸° (í…œí”Œë¦¿ ë³€ìˆ˜ë‚˜ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í™œìš©)
            // ì—¬ê¸°ì„œëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ nullë¡œ ë³´ëƒ„
            const user_uid = null; 

            await fetch('/worldcup/save/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // CSRF í† í° ì²˜ë¦¬ í•„ìš” ì‹œ ì¶”ê°€
                    // 'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    user_uid: user_uid,
                    total_rounds: parseInt(document.getElementById('round-select').value),
                    results: gameHistory
                })
            });
            console.log("ê²°ê³¼ ì €ì¥ ì„±ê³µ!");
        } catch (e) {
            console.error("ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨", e);
        }
    }
</script>

</body>
</html>