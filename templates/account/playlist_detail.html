{% extends "base.html" %}
{% block title %}í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ | 2beats{% endblock %}

{% block extra_head %}
<style>
    /* === í•˜ë‹¨ í”Œë ˆì´ì–´ ìŠ¤íƒ€ì¼ (ì œê³µí•´ì£¼ì‹  ë””ìì¸ ì ìš©) === */
    #bottom-player {
        position: fixed;
        bottom: 0; left: 0; right: 0;
        background: #fff;
        color: #333;
        padding: 0.8rem 2rem;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
        display: none;
        z-index: 1000;
        border-top: 1px solid #eee;
    }
    
    #bottom-player.active { display: block; }
    
    .player-content {
        max-width: 1200px; margin: 0 auto;
        display: grid; grid-template-columns: 280px 1fr 200px;
        gap: 2rem; align-items: center;
    }
    
    .player-info { display: flex; gap: 1rem; align-items: center; }
    
    .player-thumbnail {
        width: 56px; height: 56px; border-radius: 8px; object-fit: cover;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.3rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .player-text h4 { margin-bottom: 0.2rem; font-size: 0.95rem; font-weight: 600; color: #333; }
    .player-text p { color: #888; font-size: 0.85rem; }
    
    .player-controls { display: flex; flex-direction: column; gap: 0.4rem; }
    
    .control-buttons { display: flex; justify-content: center; gap: 0.8rem; align-items: center; }
    
    .control-btn {
        background: none; border: none; color: #666; font-size: 1.3rem;
        cursor: pointer; transition: all 0.2s; padding: 0.4rem; border-radius: 50%;
    }
    .control-btn:hover { color: #1db954; background-color: rgba(29, 185, 84, 0.1); }
    .control-btn.active { color: #1db954; }
    
    .control-btn.shuffle-off { position: relative; opacity: 0.5; }
    
    .play-btn { font-size: 2.2rem; color: #1db954; }
    .play-btn:hover { transform: scale(1.05); }
    
    .progress-container { display: flex; align-items: center; gap: 0.5rem; }
    .time { font-size: 0.75rem; color: #999; min-width: 36px; font-weight: 500; }
    
    .progress-bar {
        flex: 1; height: 4px; background: #e8e8e8;
        border-radius: 2px; cursor: pointer; position: relative;
    }
    .progress-bar:hover { height: 6px; }
    
    .progress {
        height: 100%; background: linear-gradient(90deg, #1db954, #1ed760);
        border-radius: 2px; width: 0%; position: relative;
    }
    .progress::after {
        content: ''; position: absolute; right: -5px; top: 50%; transform: translateY(-50%);
        width: 10px; height: 10px; background: #1db954; border-radius: 50%;
        opacity: 0; transition: opacity 0.2s; box-shadow: 0 1px 4px rgba(29, 185, 84, 0.4);
    }
    .progress-bar:hover .progress::after { opacity: 1; }
    
    .player-actions { display: flex; justify-content: flex-end; gap: 0.3rem; align-items: center; }
    
    .volume-control { display: flex; align-items: center; gap: 0.4rem; }
    .volume-slider { width: 70px; cursor: pointer; accent-color: #1db954; }

    /* ë‹¤í¬ ëª¨ë“œ ì˜¤ë²„ë¼ì´ë“œ (ì œê³µí•´ì£¼ì‹  CSS ë°˜ì˜) */
    :root {
        --bg: #090712; --card: #120f1f; --accent: #c084fc; --accent-2: #7c3aed;
        --text: #f7f8ff; --muted: #c7c9d9; --border: #1f1b2d;
    }
    body {
        background: radial-gradient(circle at 15% 20%, rgba(124,58,237,0.16), transparent 40%),
                    radial-gradient(circle at 80% 0%, rgba(192,132,252,0.12), transparent 45%),
                    linear-gradient(160deg, #090712, #0e0a19 60%, #0a0814);
        color: var(--text);
        padding-bottom: 100px !important; /* í”Œë ˆì´ì–´ ê³µê°„ í™•ë³´ */
    }
    .card {
        background: linear-gradient(140deg, rgba(124,58,237,0.12), rgba(192,132,252,0.12), var(--card));
        border: 1px solid var(--border);
        box-shadow: 0 22px 70px rgba(0,0,0,0.45);
    }
    #bottom-player {
        background: var(--card); color: var(--text);
        border-top: 1px solid var(--border);
        box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
    }
    .player-text h4 { color: var(--text); }
    .player-text-link { text-decoration: none; color: inherit; transition: opacity 0.2s; }
    .player-text-link:hover { opacity: 0.8; }
    .player-text-link:hover h4 { color: #1db954; }
    .control-btn { color: var(--muted); }
    .control-btn:hover { color: var(--accent); background-color: rgba(192,132,252, 0.1); }
    .control-btn.active { color: var(--accent); }
    .play-btn { color: var(--accent); }
    .progress-bar { background: rgba(255,255,255,0.1); }
    .progress { background: linear-gradient(90deg, var(--accent), var(--accent-2)); }
    .progress::after { background: var(--accent); }
    .volume-slider { accent-color: var(--accent); }

    /* ë¦¬ìŠ¤íŠ¸ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-play-all {
        display: inline-flex; align-items: center; gap: 8px;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #0b1220; border: none; padding: 10px 20px;
        border-radius: 24px; font-weight: 700; cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 15px rgba(124,58,237,0.3);
    }
    .btn-play-all:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(124,58,237,0.4); }
    
    .btn-list-play {
        width: 32px; height: 32px; border-radius: 50%;
        background: rgba(192,132,252,0.15); color: var(--accent);
        border: 1px solid rgba(192,132,252,0.3);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.2s; padding-left: 3px;
    }
    .btn-list-play:hover { background: var(--accent); color: #0b1220; }
    .playing-row { background: rgba(192,132,252,0.15) !important; }
    
    @media (max-width: 768px) {
        .player-content { grid-template-columns: 1fr auto; gap: 1rem; }
        .player-controls { display: none; }
    }
</style>
{% endblock %}

{% block content %}
<div class="loading-overlay" id="loading-overlay"><div class="spinner"></div></div>
<div class="toast-container" id="toast-container"></div>

<div style="margin-bottom:10px;">
    <a class="muted" href="{% url 'mylist' %}?tab={{ kind }}">â† ë§ˆì´ ë¦¬ìŠ¤íŠ¸ë¡œ</a>
</div>

<div class="card" style="margin-bottom:14px;">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
        <div>
            <p class="pill-label" style="margin:0 0 8px;">{% if is_music %}ìŒì•…{% else %}ì˜ìƒ{% endif %} í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</p>
            <h1 style="margin:0 0 6px;">{{ playlist.folder_name }}</h1>
            <p class="muted" style="margin:0;">ì´ {{ items.count }}ê³¡ | ìƒì„±ì¼ {{ playlist.created_at|date:"Y-m-d" }}</p>
        </div>
        
        {% if is_music and items %}
        <div>
            <button class="btn-play-all" onclick="playAll()">
                <span style="font-size:1.1rem;">â–¶</span> ì „ì²´ ì¬ìƒ
            </button>
        </div>
        {% endif %}
    </div>
</div>

<div class="card" style="margin-bottom:100px;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
        <h3 style="margin:0;">íŠ¸ë™ ëª©ë¡</h3>
        {% if items %}
            <span class="muted">ìˆœì„œë¥¼ ë³€ê²½í•˜ë ¤ë©´ ìˆ«ìë¥¼ ìˆ˜ì •í•˜ê³  ì €ì¥ì„ ëˆ„ë¥´ì„¸ìš”.</span>
        {% endif %}
    </div>

    {% if items %}
    <form method="post" action="">
        {% csrf_token %}
        <input type="hidden" name="action" value="reorder">
        <table>
            <thead>
                <tr>
                    <th style="width: 50px; text-align:center;"></th>
                    <th style="width: 70px;">ìˆœì„œ</th>
                    <th>ì œëª©</th>
                    <th>ì•„í‹°ìŠ¤íŠ¸</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr id="track-row-{{ forloop.counter0 }}">
                    <td style="text-align:center;">
                        {% if is_music and item.music.music_root %}
                        <button type="button" class="btn-list-play" onclick="playTrack({{ forloop.counter0 }})">â–¶</button>
                        {% endif %}
                    </td>
                    <td>
                        <input type="number" name="order_{{ item.id }}" value="{{ item.order }}" min="1" 
                               style="width:50px; padding:6px; border-radius:8px; border:1px solid var(--border); background:#0c0a18; color:var(--text); text-align:center;">
                    </td>
                    <td>
                        {% if is_music %}
                            <a href="{% url 'music_explore:detail' item.music.id %}" style="font-weight:bold; color:var(--text);">{{ item.music.music_title }}</a>
                        {% else %}
                            <a href="{% url 'video_explore:video_detail' item.video.id %}" style="font-weight:bold; color:var(--text);">{{ item.video.video_title }}</a>
                        {% endif %}
                    </td>
                    <td class="muted">
                        {% if is_music %}
                            {{ item.music.music_singer }}
                        {% else %}
                            {{ item.video.video_singer }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="margin-top:16px; text-align:right;">
            <button type="submit" class="btn btn-primary" style="border:none;">ìˆœì„œ ì €ì¥</button>
        </div>
    </form>
    {% else %}
    <div style="text-align:center; padding:40px 0; color:#999;">
        <p style="font-size:2rem; margin-bottom:10px;">ğŸ“­</p>
        <p>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
    </div>
    {% endif %}
</div>

<div id="bottom-player">
    <div class="player-content">
        <div class="player-info">
            <div id="player-thumbnail" class="player-thumbnail">ğŸµ</div>
            <a href="javascript:void(0)" id="player-link" class="player-text-link">
                <div class="player-text">
                    <h4 id="player-title">ìŒì•…ì„ ì„ íƒí•˜ì„¸ìš”</h4>
                    <p id="player-artist">-</p>
                </div>
            </a>
        </div>
        
        <div class="player-controls">
            <div class="control-buttons">
                <button type="button" class="control-btn" id="shuffle-btn" onclick="toggleShuffle()" title="ì…”í”Œ">ğŸ”€</button>
                <button type="button" class="control-btn" onclick="playPrev()">â®ï¸</button>
                <button type="button" class="control-btn play-btn" id="play-pause-btn" onclick="togglePlay()">â–¶ï¸</button>
                <button type="button" class="control-btn" onclick="playNext()">â­ï¸</button>
                <button type="button" class="control-btn" id="repeat-btn" onclick="toggleRepeat()" title="ë°˜ë³µ">ğŸ”</button>
            </div>
            <div class="progress-container">
                <span class="time" id="current-time">0:00</span>
                <div class="progress-bar" id="progress-bar">
                    <div class="progress" id="progress"></div>
                </div>
                <span class="time" id="duration">0:00</span>
            </div>
        </div>
        
        <div class="player-actions">
            <button type="button" class="control-btn" id="like-btn-player" onclick="toggleLikePlayer()" title="ì¢‹ì•„ìš”">ğŸ¤</button>
            <div class="volume-control">
                <button type="button" class="control-btn" id="volume-icon" onclick="toggleMute()" style="font-size: 1.1rem;">ğŸ”Š</button>
                <input type="range" min="0" max="100" value="100" 
                       class="volume-slider" id="volume-slider" 
                       oninput="changeVolume(this.value)">
            </div>
        </div>
    </div>
</div>

<audio id="global-audio"></audio>

<script>
    // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `<span>${type === 'success' ? 'âœ“' : 'â„¹ï¸'}</span><span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ===== í”Œë ˆì´ì–´ ë¡œì§ =====
    
    // 1. í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë°ì´í„° êµ¬ì„±
    const playlistData = [
      {% for item in items %}
        {% if is_music and item.music.music_root %}
        {
            index: {{ forloop.counter0 }},
            id: {{ item.music.id }},
            title: "{{ item.music.music_title|escapejs }}",
            artist: "{{ item.music.music_singer|escapejs }}",
            url: "{{ item.music.music_root.url }}",
            thumb: "{% if item.music.music_thumbnail %}{{ item.music.music_thumbnail.url }}{% endif %}"
        },
        {% endif %}
      {% endfor %}
    ];

    let currentMusicData = null;
    let currentIndex = -1;
    let isShuffled = false;
    let repeatMode = 0; // 0: off, 1: all, 2: one
    let previousVolume = 100;
    
    const audio = document.getElementById('global-audio');
    const player = document.getElementById('bottom-player');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const progress = document.getElementById('progress');
    const progressBar = document.getElementById('progress-bar');
    const currentTimeEl = document.getElementById('current-time');
    const durationEl = document.getElementById('duration');
    let isDragging = false;

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        const savedVolume = localStorage.getItem('volume');
        if (savedVolume) {
            const vol = parseFloat(savedVolume) * 100;
            document.getElementById('volume-slider').value = vol;
            updateVolumeIcon(vol);
            audio.volume = parseFloat(savedVolume);
        }
    });

    // 2. ì „ì²´ ì¬ìƒ
    function playAll() {
        if (playlistData.length > 0) {
            playTrack(0);
        } else {
            showToast("ì¬ìƒí•  ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.", 'error');
        }
    }

    // 3. íŠ¸ë™ ì¬ìƒ
    function playTrack(index) {
        if (index < 0 || index >= playlistData.length) return;

        currentIndex = index;
        const track = playlistData[index];
        currentMusicData = track;

        // UI ì—…ë°ì´íŠ¸
        document.getElementById('player-title').textContent = track.title;
        document.getElementById('player-artist').textContent = track.artist;
        
        const thumbnailEl = document.getElementById('player-thumbnail');
        if (track.thumb) {
            thumbnailEl.innerHTML = `<img src="${track.thumb}" style="width: 56px; height: 56px; border-radius: 8px; object-fit: cover;">`;
        } else {
            thumbnailEl.innerHTML = 'ğŸµ';
        }
        
        // ìƒì„¸ í˜ì´ì§€ ë§í¬ ì—…ë°ì´íŠ¸
        document.getElementById('player-link').href = `/music/detail/${track.id}/`;

        // ë¦¬ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸
        document.querySelectorAll('tbody tr').forEach(tr => tr.classList.remove('playing-row'));
        const row = document.getElementById(`track-row-${track.index}`);
        if(row) row.classList.add('playing-row');

        // ì¬ìƒ
        audio.src = track.url;
        audio.play().then(() => {
            playPauseBtn.textContent = 'â¸ï¸';
            player.classList.add('active');
            updateLikeStatus(track.id);
        }).catch(err => console.error("ì¬ìƒ ì˜¤ë¥˜:", err));
    }

    // 4. ë‹¤ìŒ/ì´ì „/ì¢…ë£Œ ì²˜ë¦¬
    function playNext() {
        if (playlistData.length === 0) return;

        let nextIndex;
        if (isShuffled) {
            nextIndex = Math.floor(Math.random() * playlistData.length);
        } else {
            nextIndex = currentIndex + 1;
            if (nextIndex >= playlistData.length) {
                if (repeatMode === 1) nextIndex = 0; // ì „ì²´ ë°˜ë³µ
                else return; // ë
            }
        }
        playTrack(nextIndex);
    }

    function playPrev() {
        if (audio.currentTime > 3) {
            audio.currentTime = 0;
            return;
        }
        let prevIndex = currentIndex - 1;
        if (prevIndex < 0) prevIndex = playlistData.length - 1;
        playTrack(prevIndex);
    }

    audio.addEventListener('ended', function() {
        if (repeatMode === 2) {
            audio.currentTime = 0;
            audio.play();
        } else {
            playNext();
        }
    });

    // 5. ì»¨íŠ¸ë¡¤ ê¸°ëŠ¥ (ì¬ìƒ/ì¼ì‹œì •ì§€, ì…”í”Œ, ë°˜ë³µ)
    function togglePlay() {
        if (audio.paused) {
            audio.play();
            playPauseBtn.textContent = 'â¸ï¸';
        } else {
            audio.pause();
            playPauseBtn.textContent = 'â–¶ï¸';
        }
    }

    function toggleShuffle() {
        isShuffled = !isShuffled;
        const btn = document.getElementById('shuffle-btn');
        if (isShuffled) {
            btn.classList.add('active');
            btn.classList.remove('shuffle-off');
        } else {
            btn.classList.remove('active');
            btn.classList.add('shuffle-off');
        }
    }

    function toggleRepeat() {
        repeatMode = (repeatMode + 1) % 3;
        const btn = document.getElementById('repeat-btn');
        switch(repeatMode) {
            case 0: btn.textContent = 'ğŸ”'; btn.classList.remove('active'); break;
            case 1: btn.textContent = 'ğŸ”'; btn.classList.add('active'); break;
            case 2: btn.textContent = 'ğŸ”‚'; btn.classList.add('active'); break;
        }
    }

    // 6. ë³¼ë¥¨ ë° ì§„í–‰ë°”
    function changeVolume(value) {
        audio.volume = value / 100;
        localStorage.setItem('volume', value / 100);
        updateVolumeIcon(value);
    }

    function updateVolumeIcon(value) {
        const icon = document.getElementById('volume-icon');
        if (value == 0) icon.textContent = 'ğŸ”‡';
        else if (value < 30) icon.textContent = 'ğŸ”ˆ';
        else if (value < 70) icon.textContent = 'ğŸ”‰';
        else icon.textContent = 'ğŸ”Š';
    }

    function toggleMute() {
        const slider = document.getElementById('volume-slider');
        if (audio.volume > 0) {
            previousVolume = slider.value;
            slider.value = 0;
            changeVolume(0);
        } else {
            slider.value = previousVolume;
            changeVolume(previousVolume);
        }
    }

    // ì§„í–‰ë°” ë“œë˜ê·¸ ë° ì—…ë°ì´íŠ¸
    audio.addEventListener('timeupdate', () => {
        if (!isDragging && audio.duration) {
            const percent = (audio.currentTime / audio.duration) * 100;
            progress.style.width = percent + '%';
            currentTimeEl.textContent = formatTime(audio.currentTime);
            durationEl.textContent = formatTime(audio.duration);
        }
    });

    function setProgress(e) {
        const rect = progressBar.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        audio.currentTime = Math.max(0, Math.min(1, pos)) * audio.duration;
    }

    progressBar.addEventListener('mousedown', (e) => { isDragging = true; setProgress(e); });
    document.addEventListener('mousemove', (e) => { if(isDragging) setProgress(e); });
    document.addEventListener('mouseup', () => { isDragging = false; });

    function formatTime(s) {
        if (isNaN(s)) return '0:00';
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return m + ':' + (sec < 10 ? '0' : '') + sec;
    }

    // 7. ì¢‹ì•„ìš” ê¸°ëŠ¥ ì—°ë™
    function updateLikeStatus(musicId) {
        {% if user.is_authenticated %}
        fetch('/music/like-status/' + musicId + '/')
            .then(res => res.json())
            .then(data => {
                const btn = document.getElementById('like-btn-player');
                if (data.is_liked) {
                    btn.textContent = 'â¤ï¸';
                    btn.style.color = '#1db954';
                } else {
                    btn.textContent = 'ğŸ¤';
                    btn.style.color = '#666';
                }
            });
        {% endif %}
    }

    function toggleLikePlayer() {
        if (!currentMusicData) return;
        {% if user.is_authenticated %}
        fetch('/music/like/' + currentMusicData.id + '/', {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(res => res.json())
        .then(data => {
            const btn = document.getElementById('like-btn-player');
            if (data.is_liked) {
                btn.textContent = 'â¤ï¸';
                btn.style.color = '#1db954';
                showToast('ì¢‹ì•„ìš” ì¶”ê°€', 'success');
            } else {
                btn.textContent = 'ğŸ¤';
                btn.style.color = '#666';
                showToast('ì¢‹ì•„ìš” ì·¨ì†Œ', 'info');
            }
        });
        {% else %}
        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
        {% endif %}
    }
    
    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return;
        if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
    });
</script>
{% endblock %}