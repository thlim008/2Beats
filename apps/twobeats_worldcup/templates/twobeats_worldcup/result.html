<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì›”ë“œì»µ ê²°ê³¼ - 2Beats</title>
    <style>
        /* --- [ê³µí†µ ìŠ¤íƒ€ì¼] --- */
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #121212;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 800px;
            text-align: center;
            padding: 40px 20px;
        }

        /* ìš°ìŠ¹ì ì¹´ë“œ (ê¸ˆìƒ‰ í…Œë‘ë¦¬ íš¨ê³¼) */
        .winner-section {
            margin-bottom: 50px;
            animation: popUp 0.8s ease-out;
        }
        .winner-badge {
            font-size: 1.5rem;
            color: #ffd700;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            font-weight: bold;
        }
        .winner-card {
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            border-radius: 20px;
            padding: 5px; /* í…Œë‘ë¦¬ ë‘ê»˜ */
            background-image: linear-gradient(45deg, #ffd700, #ffaa00, #ffd700); /* ê¸ˆìƒ‰ ê·¸ë¼ë°ì´ì…˜ */
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.3);
            display: inline-block;
        }
        .winner-content {
            background: #222;
            border-radius: 18px;
            padding: 20px;
            width: 300px;
        }
        .winner-img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .winner-title { font-size: 1.5rem; margin: 10px 0; color: white; font-weight: bold; }
        .winner-singer { color: #aaa; font-size: 1.1rem; margin: 0; }

        /* ë‚˜ë¨¸ì§€ ìˆœìœ„ ë¦¬ìŠ¤íŠ¸ */
        h3 { color: #00ff88; margin-top: 40px; margin-bottom: 20px; text-align: left;}

        .rank-list {
            list-style: none;
            padding: 0;
            width: 100%;
            text-align: left;
        }
        .rank-item {
            background: #1e1e1e;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid #333;
            transition: transform 0.2s;
        }
        .rank-item:hover { transform: translateX(5px); background: #2a2a2a; border-color: #555; }
        
        .rank-num {
            font-size: 1.2rem;
            font-weight: bold;
            width: 50px;
            text-align: center;
        }
        .rank-2 { color: #c0c0c0; } /* ì€ìƒ‰ */
        .rank-4 { color: #cd7f32; } /* ë™ìƒ‰ */
        
        .mini-thumb {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            object-fit: cover;
            background: #333;
        }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group {
            margin-top: 40px;
            margin-bottom: 60px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        button {
            padding: 15px 30px;
            font-size: 1rem;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            text-decoration: none;
        }
        .btn-save { 
            background-color: #3b82f6; /* íŒŒë€ìƒ‰ */
            color: white; 
            border: 1px solid #2563eb;
        }
        .btn-save:hover { background-color: #2563eb; }
        .btn-retry { background-color: #00ff88; color: black; }
        .btn-retry:hover { background-color: #00cc6a; }
        .btn-ranking { background-color: #333; color: white; border: 1px solid #555; }
        .btn-ranking:hover { background-color: #444; border-color: #777; }
        .btn-share {
            background-color: #ff007f; /* í•«í•‘í¬ (ì¸ìŠ¤íƒ€ ëŠë‚Œ) */
            color: white;
        }
        .btn-share:hover { background-color: #e60073; }

        @keyframes popUp {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"> /* sns ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬ */ </script> 
</head>
<body>

<div id="share-card-area" style="position: absolute; top: -9999px; left: -9999px; width: 600px; height: 900px; background: linear-gradient(135deg, #1a1a1a, #2a2a2a); padding: 40px; text-align: center; border-radius: 20px; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;">
    
    <div style="font-size: 2rem; color: #00ff88; font-weight: bold; margin-bottom: 30px; text-shadow: 0 0 10px rgba(0,255,136,0.5);">
        ğŸµ 2Beats World Cup
    </div>

    <div style="position: relative; width: 400px; height: 400px; margin-bottom: 30px;">
        <div style="position: absolute; top: -20px; left: -20px; font-size: 4rem;">ğŸ‘‘</div>
        <img id="share-img" src="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 20px; border: 5px solid #ffd700; box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);">
    </div>

    <h2 id="share-title" style="font-size: 2.5rem; margin: 10px 0; word-break: keep-all;">Title</h2>
    <p id="share-singer" style="font-size: 1.5rem; color: #aaa; margin: 0;">Singer</p>

    <div style="margin-top: 50px; padding: 15px 30px; background: #333; border-radius: 50px; font-size: 1.2rem; color: #00ff88; border: 2px solid #00ff88;">
        ë‚´ ì·¨í–¥ì˜ ìŒì•…ì„ ì°¾ì•„ë³´ì„¸ìš”!
    </div>
</div>

<div class="container">
    
    <div class="winner-section">
        <div class="winner-badge">ğŸ‘‘ ìµœì¢… ìš°ìŠ¹ (Winner)</div>
        <div class="winner-card">
            <div class="winner-content">
                {% if winner.wc_music.music_thumbnail %}
                    <img class="winner-img" src="{{ winner.wc_music.music_thumbnail.url }}" alt="winner">
                {% else %}
                    <div class="winner-img" style="background:#333;display:flex;align-items:center;justify-content:center;color:#666;">No Image</div>
                {% endif %}
                
                <h2 class="winner-title">{{ winner.wc_music.music_title }}</h2>
                <p class="winner-singer">{{ winner.wc_music.music_singer }}</p>
            </div>
        </div>
    </div>

    <h3>ğŸ“œ í”Œë ˆì´ íˆìŠ¤í† ë¦¬</h3>
    <ul class="rank-list">
        {% for result in others %}
        <li class="rank-item">
            <div class="rank-num rank-{{ result.wc_final_rank }}">
                {% if result.wc_final_rank == 2 %}ğŸ¥ˆ
                {% elif result.wc_final_rank == 4 %}ğŸ¥‰
                {% else %}{{ result.wc_final_rank }}ê°•
                {% endif %}
            </div>
            
            {% if result.wc_music.music_thumbnail %}
                <img class="mini-thumb" src="{{ result.wc_music.music_thumbnail.url }}" alt="thumb">
            {% else %}
                <div class="mini-thumb" style="display:flex;align-items:center;justify-content:center;font-size:0.7rem;">No Img</div>
            {% endif %}

            <div>
                <div style="font-weight: bold;">{{ result.wc_music.music_title }}</div>
                <div style="font-size: 0.9rem; color: #aaa;">{{ result.wc_music.music_singer }}</div>
            </div>
        </li>
        {% empty %}
        <p style="color:#666; text-align:center; padding:20px;">ë‹¤ë¥¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
    </ul>

{% if recommendations %}
    <h3 style="color: #ff99cc; margin-top: 50px;">ğŸ‘¥ ì´ ê³¡ì„ ë½‘ì€ ë¶„ë“¤ì€ ì´ëŸ° ê³¡ë„ ì¢‹ì•„í•´ìš”</h3>
    <ul class="rank-list">
        {% for music in recommendations %}
        <li class="rank-item" style="border-color: #ff99cc;">
            <div class="rank-num" style="font-size: 1.5rem;">ğŸ‘</div>
            
            {% if music.music_thumbnail %}
                <img class="mini-thumb" src="{{ music.music_thumbnail.url }}" alt="thumb">
            {% else %}
                <div class="mini-thumb" style="display:flex;align-items:center;justify-content:center;font-size:0.7rem;">No Img</div>
            {% endif %}

            <div>
                <div style="font-weight: bold;">{{ music.music_title }}</div>
                <div style="font-size: 0.9rem; color: #aaa;">{{ music.music_singer }}</div>
            </div>
            
            <div style="margin-left: auto; background: #333; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; color: #ccc;">
                {{ music.get_music_type_display }}
            </div>
        </li>
        {% endfor %}
    </ul>
    {% endif %}

    <div class="btn-group">
        <button class="btn-retry" onclick="location.href='{% url 'twobeats_worldcup:play' %}'">ğŸ”„ ë‹¤ì‹œ í•˜ê¸°</button>

        <button class="btn-share" onclick="downloadShareImage()">ğŸ“¸ ì´ë¯¸ì§€ ì €ì¥</button>
        
        {% if user.is_authenticated %}
            <button class="btn-save" onclick="saveToPlaylist()">ğŸ’¾ ê²°ê³¼ ì €ì¥</button>
        {% else %}
             <button class="btn-save" onclick="alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!')" style="opacity: 0.6;">ğŸ’¾ ê²°ê³¼ ì €ì¥</button>
        {% endif %}
        
        <button class="btn-ranking" onclick="location.href='{% url 'twobeats_worldcup:ranking' %}'">ğŸ† ë­í‚¹ ë³´ê¸°</button>
    </div>
</div>

<script>
    // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì €ì¥ ìš”ì²­ í•¨ìˆ˜
    async function saveToPlaylist() {
        const gameId = "{{ game.pk }}"; // í˜„ì¬ ê²Œì„ ID
        
        if (!confirm("í˜„ì¬ 4ê°• ì´ìƒ ì§„ì¶œí•œ ê³¡ë“¤ì„\në‚´ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
        }

        try {
            // CSRF í† í° ê°€ì ¸ì˜¤ê¸° (Django ë³´ì•ˆ í•„ìˆ˜)
            const getCookie = (name) => {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            const response = await fetch(`/worldcup/save_playlist/${gameId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            });

            const data = await response.json();

            if (response.ok) {
                alert(data.message); // "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!"
                // í•„ìš”í•˜ë‹¤ë©´ ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™
                // location.href = '/account/playlists/'; 
            } else {
                alert("ì €ì¥ ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
            }

        } catch (error) {
            console.error(error);
            alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }
    // [ì¶”ê°€] SNS ê³µìœ  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    function downloadShareImage() {
        // 1. í˜„ì¬ ìš°ìŠ¹ì ì •ë³´ë¥¼ ìº¡ì²˜ìš© ì¹´ë“œì— ì„¸íŒ…
        const originalImg = document.getElementById('winner-img-source'); // ì•„ë˜ ì„¤ëª… ì°¸ì¡° (ID ì¶”ê°€ í•„ìš”)
        const shareImg = document.getElementById('share-img');
        const shareTitle = document.getElementById('share-title');
        const shareSinger = document.getElementById('share-singer');

        // result.htmlì—ì„œ ìš°ìŠ¹ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (DOM id í™•ì¸ í•„ìš”)
        // í˜„ì¬ result.html ì½”ë“œë¥¼ ë³´ë©´ classë¡œ ë˜ì–´ ìˆê±°ë‚˜ idê°€ ì—†ì„ ìˆ˜ ìˆìŒ
        // ë”°ë¼ì„œ í™•ì‹¤í•˜ê²Œ ê°’ì„ ê°€ì ¸ì˜¤ë„ë¡ ìˆ˜ì •í•´ì•¼ í•¨.
        
        // 2. ê°’ ë³µì‚¬
        // í…œí”Œë¦¿ ë³€ìˆ˜ë¥¼ JS ë¬¸ìì—´ë¡œ ë°”ë¡œ ë„£ëŠ” ë°©ì‹ ì‚¬ìš©
        shareImg.src = "{{ winner.wc_music.music_thumbnail.url }}"; 
        shareTitle.innerText = "{{ winner.wc_music.music_title }}";
        shareSinger.innerText = "{{ winner.wc_music.music_singer }}";

        // 3. html2canvasë¡œ ìº¡ì²˜ ì‹œì‘
        const captureArea = document.getElementById('share-card-area');
        
        // ì ê¹ ë³´ì´ê²Œ ìœ„ì¹˜ ì´ë™ (í™”ë©´ ë°–ì´ì§€ë§Œ ë Œë”ë§ì€ ë˜ê²Œ)
        // html2canvasëŠ” display:none ìš”ì†Œë¥¼ ìº¡ì²˜ ëª»í•¨
        captureArea.style.top = "0";
        captureArea.style.zIndex = "-1"; // ìœ ì € ëˆˆì—ëŠ” ì•ˆ ë³´ì´ê²Œ ë’¤ë¡œ

        html2canvas(captureArea, {
            useCORS: true, // ì™¸ë¶€ ì´ë¯¸ì§€(S3 ë“±) ì‚¬ìš© ì‹œ í•„ìˆ˜
            scale: 2,      // ê³ í•´ìƒë„ (ë ˆí‹°ë‚˜ ë””ìŠ¤í”Œë ˆì´ ëŒ€ì‘)
            backgroundColor: null // ë°°ê²½ íˆ¬ëª… ë°©ì§€
        }).then(canvas => {
            // 4. ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
            const link = document.createElement('a');
            link.download = '2Beats_Winner.png';
            link.href = canvas.toDataURL("image/png");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // 5. ë‹¤ì‹œ ìˆ¨ê¸°ê¸°
            captureArea.style.top = "-9999px";
            alert("ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! SNSì— ê³µìœ í•´ë³´ì„¸ìš” ğŸ“¸");
        }).catch(err => {
            console.error(err);
            alert("ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨ (ë¸Œë¼ìš°ì € ë³´ì•ˆ ì„¤ì • ë“±ì„ í™•ì¸í•˜ì„¸ìš”)");
            captureArea.style.top = "-9999px";
        });
    }
</script>

</body>
</html>